class Mario{static MarioCharacter;static GlobalMapState}class SpriteCuts{static CreateBlackFont(){return new Engine.SpriteFont([],Engine.Resources.Images.font,8,8,this.GetCharArray(0))}static CreateRedFont(){return new Engine.SpriteFont([],Engine.Resources.Images.font,8,8,this.GetCharArray(8))}static CreateGreenFont(){return new Engine.SpriteFont([],Engine.Resources.Images.font,8,8,this.GetCharArray(16))}static CreateBlueFont(){return new Engine.SpriteFont([],Engine.Resources.Images.font,8,8,this.GetCharArray(24))}static CreateYellowFont(){return new Engine.SpriteFont([],Engine.Resources.Images.font,8,8,this.GetCharArray(32))}static CreatePinkFont(){return new Engine.SpriteFont([],Engine.Resources.Images.font,8,8,this.GetCharArray(40))}static CreateCyanFont(){return new Engine.SpriteFont([],Engine.Resources.Images.font,8,8,this.GetCharArray(48))}static CreateWhiteFont(){return new Engine.SpriteFont([],Engine.Resources.Images.font,8,8,this.GetCharArray(56))}static GetCharArray(t){let i=[];for(let e=32;e<127;e++)i[e]={X:8*(e-32),Y:t};return i}static GetBackgroundSheet(){return this.GetSheet("background",32)}static GetLevelSheet(){return this.GetSheet("map",16)}static GetSheet(t,i){let e=[];const s=Engine.Resources.Images[t].width/i,h=Engine.Resources.Images[t].height/i;for(let t=0;t<s;t++){e[t]=[];for(let s=0;s<h;s++)e[t][s]={X:t*i,Y:s*i,Width:i,Height:i}}return e}}class EnemySpriteTemplate{constructor(t,i,e){this.X=t,this.Y=i,this.SpriteTemplate=e}}class Tile{static BlockUpper=1;static BlockAll=2;static BlockLower=4;static Special=8;static Bumpable=16;static Breakable=32;static PickUpable=64;static Animated=128;static Behaviors=[];static AddValueToArr(t,i,e){for(let s=0;s<e;s++)t.push(i);return t}static LoadBehaviors(){let t=[];t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,20,1),t=this.AddValueToArr(t,28,1),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,130,4),t=this.AddValueToArr(t,2,5),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,138,1),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,162,1),t=this.AddValueToArr(t,146,1),t=this.AddValueToArr(t,154,1),t=this.AddValueToArr(t,162,1),t=this.AddValueToArr(t,146,2),t=this.AddValueToArr(t,154,1),t=this.AddValueToArr(t,146,1),t=this.AddValueToArr(t,2,1),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,1),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,192,4),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,0,4),t=this.AddValueToArr(t,2,2),t=this.AddValueToArr(t,0,4),t=this.AddValueToArr(t,2,1),t=this.AddValueToArr(t,0,9),t=this.AddValueToArr(t,2,1),t=this.AddValueToArr(t,0,70),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,1,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,1),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,1),t=this.AddValueToArr(t,0,5),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,5),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,2,3),t=this.AddValueToArr(t,0,1),t=this.AddValueToArr(t,1,3),t=this.AddValueToArr(t,0,41),t=this.AddValueToArr(t,1,3),t=this.AddValueToArr(t,0,29),this.Behaviors=t}}class LevelType{static Overground=0;static Underground=1;static Castle=2}class Odds{static Straight=0;static HillStraight=1;static Tubes=2;static Jump=3;static Cannons=4}class Level{constructor(t,i,e){this.Width=t,this.Height=i,this.ExitX=10,this.ExitY=10,this.Type=e,this.Map=[],this.Data=[],this.SpriteTemplates=[];for(let t=0;t<this.Width;t++){this.Map[t]=[],this.Data[t]=[],this.SpriteTemplates[t]=[];for(let i=0;i<this.Height;i++)this.Map[t][i]=0,this.Data[t][i]=0,this.SpriteTemplates[t][i]=null}this.JumpSections=[],this.TubeSections=[],this.StraightSections=[],this.HillStraightSections=[],this.CannonSections=[],this.EnemySpriteTemplates=[],this.CeilingRnd=[],this.RunRnd=[]}Update(){for(let t=0;t<this.Width;t++)for(let i=0;i<this.Height;i++)this.Data[t][i]>0&&this.Data[t][i]--}GetBlockCapped(t,i){return t<0&&(t=0),i<0&&(i=0),t>=this.Width&&(t=this.Width-1),i>=this.Height&&(i=this.Height-1),this.Map[t][i]}GetBlock(t,i){return t<0&&(t=0),i<0?0:(t>=this.Width&&(t=this.Width-1),i>=this.Height&&(i=this.Height-1),this.Map[t][i])}SetBlock(t,i,e){this.IsOutsideBoundaries(t,i)||(this.Map[t][i]=e)}SetBlockData(t,i,e){this.IsOutsideBoundaries(t,i)||(this.Data[t][i]=e)}IsBlocking(t,i,e,s){let h=this.GetBlock(t,i),a=(Tile.Behaviors[255&h]&Tile.BlockAll)>0;return a|=s>0&&(Tile.Behaviors[255&h]&Tile.BlockUpper)>0,a|=s<0&&(Tile.Behaviors[255&h]&Tile.BlockLower)>0,a}GetSpriteTemplate(t,i){return this.IsOutsideBoundaries(t,i)?null:this.SpriteTemplates[t][i]}SetSpriteTemplate(t,i,e){this.IsOutsideBoundaries(t,i)||(this.SpriteTemplates[t][i]=e,this.EnemySpriteTemplates.push(new EnemySpriteTemplate(t,i,e)))}IsOutsideBoundaries(t,i){return t<0||i<0||t>=this.Width||i>=this.Height}SetMap(t){this.Map=t}SetData(t){this.Data=t}SetExit(t,i){this.ExitX=t,this.ExitY=i}SetJumpSection(t){this.JumpSections.push(t)}SetJumpSections(t){this.JumpSections=t}SetTubeSection(t){this.TubeSections.push(t)}SetTubeSections(t){this.TubeSections=t}SetStraightSection(t){this.StraightSections.push(t)}SetStraightSections(t){this.StraightSections=t}SetHillStraightSection(t){this.HillStraightSections.push(t)}SetHillStraightSections(t){this.HillStraightSections=t}SetCannonSection(t){this.CannonSections.push(t)}SetCannonSections(t){this.CannonSections=t}SetCeilingRnd(t){this.CeilingRnd.push(t)}SetCeilingRndArr(t){this.CeilingRnd=t}SetRunRnd(t){this.RunRnd.push(t)}SetRunRndArr(t){this.RunRnd=t}PrintLevel(){return{Width:this.Width,Height:this.Height,ExitX:this.ExitX,ExitY:this.ExitY,Type:this.Type,EnemySpriteTemplates:this.EnemySpriteTemplates,JumpSections:this.JumpSections,TubeSections:this.TubeSections,StraightSections:this.StraightSections,HillStraightSections:this.HillStraightSections,CannonSections:this.CannonSections,CeilingRnd:this.CeilingRnd,RunRnd:this.RunRnd}}}class PredefinedLevel extends Level{constructor(t,i,e){super(t,i,e),this.coinID=0,this.powerupID=0,this.coins=[],this.powerups=[]}SetBlock(t,i,e){super.SetBlock(t,i,e);const s=Tile.Behaviors[255&e];(s&Tile.PickUpable)>0||(s&Tile.Bumpable)>0&&(s&Tile.Special)<=0?this.coins.push({ID:++this.coinID,X:t,Y:i}):(s&Tile.Special)>0&&this.powerups.push({ID:++this.powerupID,X:t,Y:i})}GetCoinID(t,i){for(let e=0;e<this.coins.length;e++)if(this.coins[e].X===t&&this.coins[e].Y===i)return this.coins[e].ID;return null}GetPowerupID(t,i){for(let e=0;e<this.powerups.length;e++)if(this.powerups[e].X===t&&this.powerups[e].Y===i)return this.powerups[e].ID;return null}}class BackgroundGenerator{constructor(t,i,e,s){this.Width=t,this.Height=i,this.Distant=e,this.Type=s}SetValues(t,i,e,s){this.Width=t,this.Height=i,this.Distant=e,this.Type=s}CreateLevel(){let t=new Level(this.Width,this.Height,this.Type);switch(this.Type){case LevelType.Overground:this.GenerateOverground(t);break;case LevelType.Underground:this.GenerateUnderground(t);break;case LevelType.Castle:this.GenerateCastle(t)}return t}GenerateOverground(t){const i=this.Distant?4:6,e=this.Distant?2:1;let s=Math.floor(Math.random()*i)+e,h=Math.floor(Math.random()*i)+e,a=0,r=0,n=0,o=0,l=2;for(a=0;a<this.Width;a++){for(s=h;s===h;)h=Math.floor(Math.random()*i)+e;for(r=0;r<this.Height;r++)n=s<h?s:h,o=s<h?h:s,l=2,r<n&&this.Distant?(l=2,r<2&&(l=r),t.SetBlock(a,r,4+8*l)):r<n?t.SetBlock(a,r,5):r===n?(l=n===h?0:1,l+=this.Distant?2:0,t.SetBlock(a,r,l)):r===o?(l=n===h?0:1,l+=this.Distant?2:0,t.SetBlock(a,r,l+16)):(l=r>o?1:0,n===s&&(l=1-l),l+=this.Distant?2:0,t.SetBlock(a,r,l+8))}}GenerateUnderground(t){let i=0,e=0,s=0,h=0;if(this.Distant){let a=0;for(i=0;i<this.Width;i++)for(Math.random()<.75&&(a=1-a),e=0;e<this.Height;e++)s=a,h=e-2,(h<0||h>4)&&(h=2,s=0),t.SetBlock(i,e,4+s+8*(3+h))}else for(i=0;i<this.Width;i++)for(e=0;e<this.Height;e++)s=i%2,h=e-1,(h<0||h>7)&&(h=7,s=0),0===s&&h>1&&h<5&&(s=-1,h=0),t.SetBlock(i,e,6+s+8*h)}GenerateCastle(t){let i=0,e=0,s=0,h=0;if(this.Distant)for(i=0;i<this.Width;i++)for(e=0;e<this.Height;e++)s=i%2,h=e-1,h>2&&h<5?h=2:h>=5&&(h-=2),h<0?(s=0,h=5):h>4?(s=1,h=5):s<1&&3===h?(s=0,h=3):s<1&&h>0&&h<3&&(s=0,h=2),t.SetBlock(i,e,1+s+8*(h+4));else for(i=0;i<this.Width;i++)for(e=0;e<this.Height;e++)s=i%3,h=e-1,h>2&&h<5?h=2:h>=5&&(h-=2),h<0?(s=1,h=5):h>4?(s=2,h=5):s<2&&4===h?(s=2,h=4):s<2&&h>0&&h<4&&(s=4,h=-3),t.SetBlock(i,e,1+s+8*(h+3))}}class BackgroundRenderer extends Engine.Drawable{constructor(t,i,e,s){super(),this.Level=t,this.Width=i,this.Distance=s,this.TilesY=1+(e/32|0),this.Background=SpriteCuts.GetBackgroundSheet()}Draw=function(t,i){let e=i.X/this.Distance,s=0,h=0,a=null,r=null,n=e/32|0,o=(e+this.Width)/32|0;for(s=n;s<=o;s++)for(h=0;h<this.TilesY;h++)a=255&this.Level.GetBlock(s,h),r=this.Background[a%8][a/8|0],t.drawImage(Engine.Resources.Images.background,r.X,r.Y,r.Width,r.Height,(s<<5)-e|0,h<<5|0,r.Width,r.Height)}}class ImprovedNoise{constructor(t){this.P=[],this.Shuffle(t)}Shuffle(t){let i=[],e=0,s=0,h=0;for(e=0;e<256;e++)i[e]=e;for(e=0;e<256;e++)s=(255*Math.random()|0)+e,h=i[e],i[e]=i[s],i[s]=h,this.P[e+256]=this.P[e]=i[e]}PerlinNoise(t,i){let e=0,s=0,h=0;for(e=0;e<8;e++)h=64/(1<<e),s+=this.Noise(t/h,i/h,128)/(1<<e);return s}Noise(t,i,e){let s=255&(0|t),h=255&(0|i),a=255&(0|e);t-=0|t,i-=0|i,e-=0|e;let r=this.Fade(t),n=this.Fade(i),o=this.Fade(e),l=this.P[s]+h,d=this.P[l]+a,c=this.P[l+1]+a,u=this.P[s+1]+h,g=this.P[u]+a,p=this.P[u+1]+a;return this.Lerp(o,this.Lerp(n,this.Lerp(r,this.Grad(this.P[d],t,i,e),this.Grad(this.P[g],t-1,i,e)),this.Lerp(r,this.Grad(this.P[c],t,i-1,e),this.Grad(this.P[p],t-1,i-1,e))),this.Lerp(n,this.Lerp(r,this.Grad(this.P[d+1],t,i,e-1),this.Grad(this.P[g+1],t-1,i,e-1)),this.Lerp(r,this.Grad(this.P[c+1],t,i-1,e-1),this.Grad(this.P[p+1],t-1,i-1,e-1))))}Fade(t){return t*t*t*(t*(6*t-15)+10)}Lerp(t,i,e){return i+t*(e-i)}Grad(t,i,e,s){let h=15&t,a=h<8?i:e,r=h<4?e:12===h||14===h?i:s;return(0==(1&h)?a:-a)+(0==(2&h)?r:-r)}}class NotchSprite extends Engine.Drawable{constructor(t){super(),this.XOld=0,this.YOld=0,this.X=0,this.Y=0,this.Xa=0,this.Ya=0,this.XPic=0,this.YPic=0,this.XPicO=0,this.YPicO=0,this.PicWidth=32,this.PicHeight=32,this.XFlip=!1,this.YFlip=!1,this.Visible=!0,this.Image=t,this.Delta=0,this.SpriteTemplate=null,this.Layer=1}Draw(t,i){let e=0,s=0;this.Visible&&(e=(this.XOld+(this.X-this.XOld)*this.Delta|0)-this.XPicO,s=(this.YOld+(this.Y-this.YOld)*this.Delta|0)-this.YPicO,t.save(),t.scale(this.XFlip?-1:1,this.YFlip?-1:1),t.translate(this.XFlip?-320:0,this.YFlip?-240:0),t.drawImage(this.Image,this.XPic*this.PicWidth,this.YPic*this.PicHeight,this.PicWidth,this.PicHeight,this.XFlip?320-e-this.PicWidth:e,this.YFlip?240-s-this.PicHeight:s,this.PicWidth,this.PicHeight),t.restore())}Update(t){this.XOld=this.X,this.YOld=this.Y,this.Move(),this.Delta=t}UpdateNoMove(t){this.XOld=this.X,this.YOld=this.Y,this.Delta=0}Move(){this.X+=this.Xa,this.Y+=this.Ya}GetX(t){return(this.XOld+(this.X-this.XOld)*t|0)-this.XPicO}GetY(t){return(this.YOld+(this.Y-this.YOld)*t|0)-this.YPicO}CollideCheck(){}BumpCheck(t,i){}Release(t){}ShellCollideCheck(t){return!1}FireballCollideCheck(t){return!1}}class CauseOfDeath{static Hole=1;static Enemy=2}class Character extends NotchSprite{constructor(){super(null),this.Large=!1,this.Fire=!1,this.Coins=0,this.Lives=1,this.LevelString="none",this.GroundInertia=.89,this.AirInertia=.89,this.RunTime=0,this.WasOnGround=!1,this.OnGround=!1,this.MayJump=!1,this.Ducking=!1,this.Sliding=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.CanShoot=!1,this.Width=4,this.Height=24,this.World=null,this.Facing=0,this.PowerUpTime=0,this.XDeathPos=0,this.YDeathPos=0,this.DeathTime=0,this.WinTime=0,this.InvulnerableTime=0,this.Carried=null,this.LastLarge=!1,this.LastFire=!1,this.NewLarge=!1,this.NewFire=!1,this.gameplayMetrics=new GameplayMetrics}Initialize(t){this.World=t,this.X=32,this.Y=0,this.PowerUpTime=0,this.RunTime=0,this.WasOnGround=!1,this.OnGround=!1,this.MayJump=!1,this.Ducking=!1,this.Sliding=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.CanShoot=!1,this.Width=4,this.Height=24,this.World=t,this.Facing=0,this.PowerUpTime=0,this.XDeathPos=0,this.YDeathPos=0,this.DeathTime=0,this.WinTime=0,this.InvulnerableTime=0,this.Carried=null,this.SetLarge(this.Large,this.Fire)}SetLarge(t,i){i&&(t=!0),t||(i=!1),this.LastLarge=this.Large,this.LastFire=this.Fire,this.Large=t,this.Fire=i,this.NewLarge=this.Large,this.NewFire=this.Fire,this.Blink(!0)}Blink(t){this.Large=t?this.NewLarge:this.LastLarge,this.Fire=t?this.NewFire:this.LastFire,this.Large?(this.Image=Engine.Resources.Images[this.Fire?"fireMario":"mario"],this.XPicO=16,this.YPicO=31,this.PicWidth=this.PicHeight=32):(this.Image=Engine.Resources.Images.smallMario,this.XPicO=8,this.YPicO=15,this.PicWidth=this.PicHeight=16)}Move(){if(this.WinTime>0)return this.WinTime++,this.Xa=0,void(this.Ya=0);if(this.DeathTime>0)return this.DeathTime++,this.DeathTime<11?(this.Xa=0,this.Ya=0):11===this.DeathTime?this.Ya=-15:this.Ya+=2,this.X+=this.Xa,void(this.Y+=this.Ya);if(0!==this.PowerUpTime)return this.PowerUpTime>0?(this.PowerUpTime--,this.Blink(0==(1&(this.PowerUpTime/3|0)))):(this.PowerUpTime++,this.Blink(0==(1&(-this.PowerUpTime/3|0)))),0===this.PowerUpTime&&(this.World.Paused=!1),void this.CalcPic();this.InvulnerableTime>0&&this.InvulnerableTime--,this.Visible=0==(1&(this.InvulerableTime/2|0)),this.WasOnGround=this.OnGround;let t=Engine.KeyboardInput.IsKeyDown(Engine.Keys.A)?1.2:.6;this.OnGround&&(Engine.KeyboardInput.IsKeyDown(Engine.Keys.Down)&&this.Large?this.Ducking=!0:this.Ducking=!1),this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),Engine.KeyboardInput.IsKeyDown(Engine.Keys.S)||this.JumpTime<0&&!this.OnGround&&!this.Sliding?this.JumpTime<0?(this.Xa=this.XJumpSpeed,this.Ya=-this.JumpTime*this.YJumpSpeed,this.JumpTime++):this.OnGround&&this.MayJump?(Engine.Resources.PlaySound("jump"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=7,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.gameplayMetrics.RegisterJump()):this.Sliding&&this.MayJump?(Engine.Resources.PlaySound("jump"),this.XJumpSpeed=6*-this.Facing,this.YJumpSpeed=-2,this.JumpTime=-6,this.Xa=this.XJumpSpeed,this.Ya=-this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.Facing=-this.Facing,this.gameplayMetrics.RegisterJump()):this.JumpTime>0&&(this.Xa+=this.XJumpSpeed,this.Ya=this.JumpTime*this.YJumpSpeed,this.JumpTime--):this.JumpTime=0,Engine.KeyboardInput.IsKeyDown(Engine.Keys.Left)&&!this.Ducking&&(1===this.Facing&&(this.Sliding=!1),this.Xa-=t,this.JumpTime>=0&&(this.Facing=-1)),Engine.KeyboardInput.IsKeyDown(Engine.Keys.Right)&&!this.Ducking&&(-1===this.Facing&&(this.Sliding=!1),this.Xa+=t,this.JumpTime>=0&&(this.Facing=1)),(!Engine.KeyboardInput.IsKeyDown(Engine.Keys.Left)&&!Engine.KeyboardInput.IsKeyDown(Engine.Keys.Right)||this.Ducking||this.Ya<0||this.OnGround)&&(this.Sliding=!1),Engine.KeyboardInput.IsKeyDown(Engine.Keys.A)&&this.CanShoot&&this.Fire&&this.World.FireballsOnScreen<2&&(Engine.Resources.PlaySound("fireball"),this.World.AddSprite(new Fireball(this.World,this.X+6*this.Facing,this.Y-20,this.Facing))),this.CanShoot=!Engine.KeyboardInput.IsKeyDown(Engine.Keys.A),this.MayJump=(this.OnGround||this.Sliding)&&!Engine.KeyboardInput.IsKeyDown(Engine.Keys.S),this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,Math.abs(this.Xa)<.5&&(this.RunTime=0,this.Xa=0),this.CalcPic(),this.Sliding&&(this.World.AddSprite(new Sparkle(this.World,(this.X+4*Math.random()-2|0)+8*this.Facing,(this.Y+4*Math.random()|0)-24,2*Math.random()-1,Math.random(),0,1,5)),this.Ya*=.5),this.OnGround=!1,this.SubMove(this.Xa,0),this.SubMove(0,this.Ya),this.Y>16*this.World.Level.Height+16&&this.Die(),this.X<0&&(this.X=0,this.Xa=0),this.X>16*this.World.Level.ExitX&&this.Win(),this.X>16*this.World.Level.Width&&(this.X=16*this.World.Level.Width,this.Xa=0),this.Ya*=.85,this.OnGround?this.Xa*=this.GroundInertia:this.Xa*=this.AirInertia,this.OnGround||(this.Ya+=3),null!==this.Carried&&(this.Carried.X*=this.X+8*this.Facing,this.Carried.Y*=this.Y-2,Engine.KeyboardInput.IsKeyDown(Engine.Keys.A)||(this.Carried.Release(this),this.Carried=null))}CalcPic(){let t=0,i=0;if(this.Large?(t=(this.RunTime/20|0)%4,3===t&&(t=1),null===this.Carried&&Math.abs(this.Xa)>10&&(t+=3),null!==this.Carried&&(t+=10),this.OnGround||(t=null!==this.Carried?12:Math.abs(this.Xa)>10?7:6)):(t=(this.RunTime/20|0)%2,null===this.Carried&&Math.abs(this.Xa)>10&&(t+=2),null!==this.Carried&&(t+=8),this.OnGround||(t=null!==this.Carried?9:Math.abs(this.Xa)>10?5:4)),this.OnGround&&(-1===this.Facing&&this.Xa>0||1===this.Facing&&this.Xa<0)&&((this.Xa>1||this.Xa<-1)&&(t=this.Large?9:7),this.Xa>3||this.Xa<-3))for(i=0;i<3;i++)this.World.AddSprite(new Sparkle(this.World,this.X+8*Math.random()-4|0,this.Y+4*Math.random()|0,2*Math.random()-1,-1*Math.random(),0,1,5));this.Large?(this.Ducking&&(t=14),this.Height=this.Ducking?12:24):this.Height=12,this.XPic=t}SubMove(t,i){let e=!1;for(;t>8;){if(!this.SubMove(8,0))return!1;t-=8}for(;t<-8;){if(!this.SubMove(-8,0))return!1;t+=8}for(;i>8;){if(!this.SubMove(0,8))return!1;i-=8}for(;i<-8;){if(!this.SubMove(0,-8))return!1;i+=8}return(i>0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t-this.Width,this.Y+i+1,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i+1,t,i))||i<0&&(this.IsBlocking(this.X+t,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)))&&(e=!0),t>0&&(this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,i)?(this.Sliding=!0,e=!0):this.Sliding=!1),t<0&&(this.Sliding=!0,this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i,t,i)?(this.Sliding=!0,e=!0):this.Sliding=!1),e?(t<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),t>0&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),i<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.JumpTime=0,this.Ya=0),i>0&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.WasOnGround||this.gameplayMetrics.RegisterLanding(),this.OnGround=!0),!1):(this.X+=t,this.Y+=i,!0)}IsBlocking(t,i,e,s){let h=!1,a=0,r=0,n=0;if(i=i/16|0,(t=t/16|0)===(this.X/16|0)&&i===(this.Y/16|0))return!1;if(a=this.World.Level.GetBlock(t,i),(Tile.Behaviors[255&a]&Tile.PickUpable)>0)for(this.GetCoin(t,i),Engine.Resources.PlaySound("coin"),this.World.Level.SetBlock(t,i,0),r=0;r<2;r++)for(n=0;n<2;n++)this.World.AddSprite(new Sparkle(this.World,16*t+8*r+(8*Math.random()|0),16*i+8*n+(8*Math.random()|0),0,0,0,2,5));return h=this.World.Level.IsBlocking(t,i,e,s),h&&s<0&&this.World.Bump(t,i,this.Large),h}Stomp(t){let i=0;this.DeathTime>0||this.World.Paused||(i=t.Y-t.Height/2,this.SubMove(0,i-this.Y),t instanceof Enemy||t instanceof BulletBill?(Engine.Resources.PlaySound("kick"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=8,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.InvulnerableTime=1):t instanceof Shell&&(Engine.KeyboardInput.IsKeyDown(Engine.Keys.A)&&0===t.Facing?(this.Carried=t,t.Carried=!0):(Engine.Resources.PlaySound("kick"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=8,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.InvulnerableTime=1)))}GetHurt(){this.DeathTime>0||this.World.Paused||this.InvulnerableTime>0||(this.Large?(this.World.Paused=!0,this.PowerUpTime=-18,Engine.Resources.PlaySound("powerdown"),this.SetLarge(this.Fire,!1),this.InvulnerableTime=32):this.Die())}Win(){this.XDeathPos=0|this.X,this.YDeathPos=0|this.Y,this.World.Paused=!0,this.WinTime=1,Engine.Resources.PlaySound("exit"),this.gameplayMetrics.RegisterEndingTime()}Die(){this.XDeathPos=0|this.X,this.YDeathPos=0|this.Y,this.World.Paused=!0,this.DeathTime=1,Engine.Resources.PlaySound("death"),this.SetLarge(!1,!1),this.gameplayMetrics.RegisterEndingTime()}GetFlower(t,i){this.DeathTime>0&&this.World.Paused||(this.gameplayMetrics.CollectedPowerup(t,i),this.Fire?(this.GetCoin(),Engine.Resources.PlaySound("coin")):(this.World.Paused=!0,this.PowerUpTime=18,Engine.Resources.PlaySound("powerup"),this.SetLarge(!0,!0)))}GetMushroom(t,i){this.DeathTime>0&&this.World.Paused||(this.gameplayMetrics.CollectedPowerup(t,i),this.Large?(this.GetCoin(),Engine.Resources.PlaySound("coin")):(this.World.Paused=!0,this.PowerUpTime=18,Engine.Resources.PlaySound("powerup"),this.SetLarge(!0,!1)))}Kick(t){this.DeathTime>0&&this.World.Paused||(Engine.KeyboardInput.IsKeyDown(Engine.Keys.A)?(this.Carried=t,t.Carried=!0):(Engine.Resources.PlaySound("kick"),this.InvulnerableTime=1))}Get1Up(){Engine.Resources.PlaySound("1up"),this.Lives++,99===this.Lives&&(this.Lives=99)}GetCoin(t,i){void 0!==t&&void 0!==i&&this.gameplayMetrics.CollectedCoin(t,i),this.Coins++,100===this.Coins&&(this.Coins=0,this.Get1Up())}ResetMetrics(){this.gameplayMetrics=new GameplayMetrics}}class LevelRenderer extends Engine.Drawable{constructor(t,i,e){super(),this.Width=i,this.Height=e,this.Level=t,this.TilesY=1+(e/16|0),this.Delta=0,this.Tick=0,this.Bounce=0,this.AnimTime=0,this.Background=SpriteCuts.GetLevelSheet()}Update(t){this.AnimTime+=t,this.Tick=0|this.AnimTime,this.Bounce+=30*t,this.Delta=t}Draw(t,i){this.DrawStatic(t,i),this.DrawDynamic(t,i)}DrawStatic(t,i){let e=0,s=0,h=0,a=null,r=i.X/16|0,n=(i.X+this.Width)/16|0;for(e=r;e<n+1;e++)for(s=0;s<this.TilesY;s++)h=255&this.Level.GetBlock(e,s),0==(Tile.Behaviors[h]&Tile.Animated)&&(a=this.Background[h%16][h/16|0],t.drawImage(Engine.Resources.Images.map,a.X,a.Y,a.Width,a.Height,(e<<4)-i.X|0,s<<4|0,a.Width,a.Height))}DrawDynamic(t,i){let e=0,s=0,h=0,a=0,r=0,n=null;for(e=i.X/16|0;e<=(i.X+this.Width)/16|0;e++)for(s=i.Y/16|0;s<=(i.Y+this.Height)/16|0;s++)h=this.Level.GetBlock(e,s),(Tile.Behaviors[255&h]&Tile.Animated)>0&&(a=(this.Bounce/3|0)%4,0==(h%16/4|0)&&1==(h/16|0)&&(a=(this.Bounce/2+(e+s)/8|0)%20,a>3&&(a=0)),3==(h%16/4|0)&&0==(h/16|0)&&(a=2),r=0,e>=0&&s>=0&&e<this.Level.Width&&s<this.Level.Height&&(r=this.Level.Data[e][s]),r>0&&(r=8*Math.sin((r-this.Delta)/4*Math.PI)|0),n=this.Background[4*(h%16/4|0)+a][h/16|0],t.drawImage(Engine.Resources.Images.map,n.X,n.Y,n.Width,n.Height,(e<<4)-i.X,(s<<4)-i.Y-r,n.Width,n.Height))}DrawExit0(t,i,e){let s=0,h=0,a=null;for(s=this.Level.ExitY-8;s<this.Level.ExitY;s++)a=this.Background[12][s===this.Level.ExitY-8?4:5],t.drawImage(Engine.Resources.Images.map,a.X,a.Y,a.Width,a.Height,(this.Level.ExitX<<4)-i.X-16,(s<<4)-i.Y,a.Width,a.Height);e&&(h=16*this.Level.ExitY-48-3*Math.sin(this.AnimTime)*16-8,a=this.Background[12][3],t.drawImage(Engine.Resources.Images.map,a.X,a.Y,a.Width,a.Height,(this.Level.ExitX<<4)-i.X-16,h-i.Y,a.Width,a.Height),a=this.Background[13][3],t.drawImage(Engine.Resources.Images.map,a.X,a.Y,a.Width,a.Height,(this.Level.ExitX<<4)-i.X,h-i.Y,a.Width,a.Height))}DrawExit1(t,i){let e=0,s=null;for(e=this.Level.ExitY-8;e<this.Level.ExitY;e++)s=this.Background[13][e===this.Level.ExitY-8?4:5],t.drawImage(Engine.Resources.Images.map,s.X,s.Y,s.Width,s.Height,(this.Level.ExitX<<4)-i.X+16,(e<<4)-i.Y,s.Width,s.Height)}}class JumpSection{constructor(t,i,e,s,h,a){this.JS=t,this.JL=i,this.Length=e,this.X0=s,this.HasStairs=h,this.Floor=a}GetHoleStartX(){return this.X0+this.JS}GetHoleEndX(){return this.X0+this.Length-this.JS-1}GetFloor(){return this.Floor}}class TubeSection{constructor(t,i,e,s,h){this.Length=i,this.Floor=e,this.XTube=s,this.TubeHeight=h,this.X0=t,this.XTubeRndValues=[],this.TubeHeightRndValues=[]}AddXTubeRndValue(t){this.XTubeRndValues.push(t)}AddTubeHeightRndValue(t){this.TubeHeightRndValues.push(t)}}class StraightSection{constructor(t,i,e){this.X0=t,this.Length=i,this.Floor=e,this.Decorate=null}SetDecorate(t){this.Decorate=t}}class HillStraightSection{constructor(t,i,e){this.X0=t,this.Length=i,this.Floor=e,this.Hrnd=[],this.Lrnd=[],this.XXOrnd=[],this.Blocks=[],this.DecorateIteration=-1,this.Decorate=null}SetDecorate(t){this.Decorate=t}SetHrndValue(t){this.Hrnd.push(t)}SetLrndValue(t){this.Lrnd.push(t)}SetXXOrndValue(t){this.XXOrnd.push(t)}SetDecorateIteration(t){this.DecorateIteration=t}AddGetBlock(t,i){this.Blocks.length<=t&&this.Blocks.push([]),this.Blocks[t].push(i)}}class CannonSection{constructor(t,i,e){this.Length=t,this.Floor=i,this.X0=e,this.XCannon=[],this.CannonHeight=[]}AddXCannon(t){this.XCannon.push(t)}AddCannonHeight(t){this.CannonHeight.push(t)}}class DecorateSection{constructor(t,i,e){this.X0=t,this.X1=i,this.Floor=e,this.SBegin=0,this.SEnd=0,this.EBegin=0,this.EEnd=0,this.Rnd1=[],this.Rnd2=[],this.Rnd3=[],this.Rnd4=[]}SetBegin(t,i){this.SBegin=t,this.EBegin=i}SetEnd(t,i){this.SEnd=t,this.EEnd=i}SetRandomValues(t,i,e,s){this.Rnd1.push(t),this.Rnd2.push(i),this.Rnd3.push(e),this.Rnd4.push(s)}}class LevelGenerator{constructor(t,i){this.Width=t,this.Height=i,this.Odds=[],this.TotalOdds=0,this.Difficulty=0,this.Type=0}CreateLevel(t,i){let e=0,s=0,h=0,a=0,r=null;this.Type=t,this.Difficulty=i,this.Odds[Odds.Straight]=20,this.Odds[Odds.HillStraight]=10,this.Odds[Odds.Tubes]=2+i,this.Odds[Odds.Jump]=2*i,this.Odds[Odds.Cannon]=5*i-10,this.Type!==LevelType.Overground&&(this.Odds[Odds.HillStraight]=0);for(let t=0;t<this.Odds.length;t++)this.Odds[t]<0&&(this.Odds[t]=0),this.TotalOdds+=this.Odds[t],this.Odds[t]=this.TotalOdds-this.Odds[t];for(r=new Level(this.Width,this.Height,t),e+=this.BuildStraight(r,0,r.Width,!0);e<r.Width-64;)e+=this.BuildZone(r,e,r.Width-e);s=this.Height-1-4*Math.random()|0,r.ExitX=e+8,r.ExitY=s;for(let t=e;t<r.Width;t++)for(let i=0;i<this.Height;i++)i>=s&&r.SetBlock(t,i,145);if(t===LevelType.Castle||t===LevelType.Underground)for(let t=0;t<r.Width;t++){a--<=0&&t>4&&(h=4*Math.random()|0,a=4+(4*Math.random()|0),r.SetCeilingRnd(h),r.SetRunRnd(a));for(let i=0;i<r.Height;i++)(t>4&&i<=h||t<1)&&r.SetBlock(t,i,145)}return this.FixWalls(r),r}BuildZone(t,i,e){let s=Math.random()*this.TotalOdds|0,h=0,a=0;for(a=0;a<this.Odds.length;a++)this.Odds[a]<=s&&(h=a);switch(h){case Odds.Straight:return this.BuildStraight(t,i,e,!1);case Odds.HillStraight:return this.BuildHillStraight(t,i,e);case Odds.Tubes:return this.BuildTubes(t,i,e);case Odds.Jump:return this.BuildJump(t,i,e);case Odds.Cannons:return this.BuildCannons(t,i,e)}return 0}BuildJump(t,i,e){let s=2+(4*Math.random()|0),h=2+(2*Math.random()|0),a=2*s+h,r=0==(3*Math.random()|0),n=this.Height-1-(4*Math.random()|0),o=new JumpSection(s,h,a,i,r,n);return t.SetJumpSection(o),this.BuildJumpSection(t,o),a}BuildJumpSection(t,i){for(let e=i.X0;e<i.X0+i.Length;e++)if(e<i.X0+i.JS||e>i.X0+i.Length-i.JS-1)for(let s=0;s<this.Height;s++)s>=i.Floor?t.SetBlock(e,s,145):(i.HasStairs&&e<i.X0+i.JS&&s>=i.Floor-(e-i.X0)+1||i.HasStairs&&e>=i.X0+i.JS&&s>=i.Floor-(i.X0+i.Length-e)+2)&&t.SetBlock(e,s,9)}BuildCannons(t,i,e){let s=2+(10*Math.random()|0),h=this.Height-1-4*Math.random()|0,a=i+1+4*Math.random()|0;s>e&&(s=e);let r=new CannonSection(s,h,i);for(let e=i;e<i+s;e++){e>a&&(a+=4*Math.random()*2|0),a===i+s-1&&(a+=10);const n=h-(4*Math.random()|0)-1;r.AddXCannon(a),r.AddCannonHeight(n);for(let i=0;i<this.Height;i++)i>=h?t.SetBlock(e,i,145):i<h&&e===a&&i>=n&&(i===n?t.SetBlock(e,i,14):i===n+1?t.SetBlock(e,i,30):t.SetBlock(e,i,46))}return t.SetCannonSection(r),s}BuildHillStraight(t,i,e){let s=10+(10*Math.random()|0),h=this.Height-1-4*Math.random()|0;s>e&&(s=e);let a=new HillStraightSection(i,s,h);for(let e=i;e<i+s;e++)for(let i=0;i<this.Height;i++)i>=h&&t.SetBlock(e,i,145);this.AddEnemyLine(t,i+1,i+s-1,h-1);let r=h,n=0,o=0,l=[],d=0,c=!0;for(;c&&(r=r-2-3*Math.random()|0,a.SetHrndValue(r),!(r<=0))&&(n=3+(5*Math.random()|0),a.SetLrndValue(n),o=(Math.random()*(s-n-2)|0)+i+1,a.SetXXOrndValue(o),!(l[o-i]||l[o-i+n]||l[o-i-1]||l[o-i+n+1]));){l[o-i]=!0,l[o-i+n]=!0,this.AddEnemyLine(t,o,o+n,r-1),0==(4*Math.random()|0)&&(a.SetDecorateIteration(d),a.SetDecorate(this.Decorate(t,o-1,o+n+1,r)),c=!1);for(let i=o;i<o+n;i++)for(let e=r;e<h;e++){let s=5,h=9;i===o&&(s=4),i===o+n-1&&(s=6),e===r&&(h=8),a.AddGetBlock(d,t.GetBlock(i,e)),0===t.GetBlock(i,e)?t.SetBlock(i,e,s+16*h):(132===t.GetBlock(i,e)&&t.SetBlock(i,e,180),134===t.GetBlock(i,e)&&t.SetBlock(i,e,182))}d++}return t.SetHillStraightSection(a),s}AddEnemyLine(t,i,e,s){let h=0,a=0;for(h=i;h<e;h++)(35*Math.random()|0)<this.Difficulty+1&&(a=4*Math.random()|0,this.Difficulty<1?a=Enemy.Goomba:this.Difficulty<3&&(a=3*Math.random()|0),t.SetSpriteTemplate(h,s,new SpriteTemplate(a,(35*Math.random()|0)<this.Difficulty)))}BuildTubes(t,i,e){let s=5+(10*Math.random()|0),h=this.Height-1-4*Math.random()|0,a=i+1+4*Math.random()|0,r=h-(2*Math.random()|0)-2,n=new TubeSection(i,s,h,a,r);s>e&&(s=e);for(let e=i;e<i+s;e++){if(e>a+1){let t=4*Math.random()|0;a+=3+t,n.AddXTubeRndValue(t),t=2*Math.random()|0,r=h-t-2,n.AddTubeHeightRndValue(t)}a>=i+s-2&&(a+=10),e===a&&(11*Math.random()|0)<this.Difficulty+1&&t.SetSpriteTemplate(e,r,new SpriteTemplate(Enemy.Flower,!1));for(let i=0;i<this.Height;i++)if(i>=h)t.SetBlock(e,i,145);else if(i<h&&(e===a||e===a+1)&&i>=r){let s=10+e-a;i===r?t.SetBlock(e,i,s):t.SetBlock(e,i,s+16)}}return t.SetTubeSection(n),s}BuildStraight(t,i,e,s){let h=2+(10*Math.random()|0),a=this.Height-1-(4*Math.random()|0);s&&(h=10+(5*Math.random()|0)),h>e&&(h=e);let r=new StraightSection(i,h,a);for(let e=i;e<i+h;e++)for(let i=0;i<this.Height;i++)i>=a&&t.SetBlock(e,i,145);return!s&&h>5&&r.SetDecorate(this.Decorate(t,i,i+h,a)),t.SetStraightSection(r),h}Decorate(t,i,e,s){if(s<1)return null;let h=new DecorateSection(i,e,s),a=4*Math.random()|0,r=4*Math.random()|0;if(h.SetBegin(a,r),this.AddEnemyLine(t,i+1,e-1,s-1),s-2>0&&e-1-r-(i+1+a)>1)for(let h=i+1+a;h<e-1-r;h++)t.SetBlock(h,s-2,34);if(a=4*Math.random()|0,r=4*Math.random()|0,h.SetEnd(a,r),s-4>0&&e-1-r-(i+1+a)>2)for(let n=i+1+a;n<e-1-r;n++){const a=3*Math.random()|0,r=4*Math.random()|0,o=4*Math.random()|0,l=4*Math.random()|0;h.SetRandomValues(a,r,o,l),n!==i+1&&n!==e-2&&0===a?t.SetBlock(n,s-4,0===r?22:21):0===o?t.SetBlock(n,s-4,0===l?18:17):t.SetBlock(n,s-4,16)}return h}FixWalls(t){let i=[],e=0,s=0,h=0,a=0,r=0;for(e=0;e<this.Width+1;e++)for(i[e]=[],s=0;s<this.Height+1;s++){for(r=0,h=e-1;h<e+1;h++)for(a=s-1;a<s+1;a++)145===t.GetBlockCapped(h,a)&&r++;i[e][s]=4===r}this.Blockify(t,i,this.Width+1,this.Height+1)}Blockify(t,i,e,s){let h=0,a=[],r=0,n=0,o=0,l=0,d=0,c=0,u=0;for(d=0;d<2;d++)a[d]=[];for(this.Type===LevelType.Castle?h=8:this.Type===LevelType.Underground&&(h=12),r=0;r<e;r++)for(n=0;n<s;n++){for(o=r;o<=r+1;o++)for(l=n;l<=n+1;l++)c=o,u=l,c<0&&(c=0),u<0&&(u=0),c>e-1&&(c=e-1),u>s-1&&(u=s-1),a[o-r][l-n]=i[c][u];a[0][0]===a[1][0]&&a[0][1]===a[1][1]?a[0][0]===a[0][1]?a[0][0]&&t.SetBlock(r,n,145+h):a[0][0]?t.SetBlock(r,n,161+h):t.SetBlock(r,n,129+h):a[0][0]===a[0][1]&&a[1][0]===a[1][1]?a[0][0]?t.SetBlock(r,n,146+h):t.SetBlock(r,n,144+h):a[0][0]===a[1][1]&&a[0][1]===a[1][0]?t.SetBlock(r,n,145+h):a[0][0]===a[1][0]?a[0][0]?a[0][1]?t.SetBlock(r,n,163+h):t.SetBlock(r,n,179+h):a[0][1]?t.SetBlock(r,n,130+h):t.SetBlock(r,n,128+h):a[0][1]===a[1][1]?a[0][1]?a[0][0]?t.SetBlock(r,n,147+h):t.SetBlock(r,n,131+h):a[0][0]?t.SetBlock(r,n,162+h):t.SetBlock(r,n,160+h):t.SetBlock(r,n,1+16*h)}}}class PredefinedLevelGenerator extends LevelGenerator{constructor(t){super(t.Width,t.Height),this.level=t}CreateLevel(){let t=new PredefinedLevel(this.Width,this.Height,this.level.Type);this.Type=this.level.Type;for(let i=0;i<this.level.JumpSections.length;i++){const e=this.level.JumpSections[i],s=new JumpSection(e.JS,e.JL,e.Length,e.X0,e.HasStairs,e.Floor);t.SetJumpSection(s),super.BuildJumpSection(t,s)}t.SetStraightSections(this.level.StraightSections);for(let i=0;i<this.level.StraightSections.length;i++)this.BuildStraight(t,this.level.StraightSections[i]);t.SetTubeSections(this.level.TubeSections);for(let i=0;i<this.level.TubeSections.length;i++)this.BuildTubes(t,this.level.TubeSections[i]);t.SetHillStraightSections(this.level.HillStraightSections);for(let i=0;i<this.level.HillStraightSections.length;i++)this.BuildHillStraight(t,this.level.HillStraightSections[i]);t.SetCannonSections(this.level.CannonSections);for(let i=0;i<this.level.CannonSections.length;i++)this.BuildCannons(t,this.level.CannonSections[i]);t.ExitX=this.level.ExitX,t.ExitY=this.level.ExitY;const i=this.level.ExitX-8,e=t.ExitY;for(let s=i;s<t.Width;s++)for(let i=0;i<this.Height;i++)i>=e&&t.SetBlock(s,i,145);const s=this.level.EnemySpriteTemplates;for(let i=0;i<s.length;i++)t.SetSpriteTemplate(s[i].X,s[i].Y,new SpriteTemplate(s[i].SpriteTemplate.Type,s[i].SpriteTemplate.Winged));if(this.level.Type===LevelType.Castle||this.level.Type===LevelType.Underground){let i=0,e=0,s=0;for(let h=0;h<t.Width;h++){e--<=0&&h>4&&(s=this.level.CeilingRnd[i],e=this.level.RunRnd[i],i++);for(let i=0;i<t.Height;i++)(h>4&&i<=s||h<1)&&t.SetBlock(h,i,145)}}return this.FixWalls(t),Mario.MarioCharacter.gameplayMetrics.RegisterNoCoins(t.coins.length),Mario.MarioCharacter.gameplayMetrics.RegisterNoPowerups(t.powerups.length),t}BuildTubes(t,i){const e=i.Length,s=i.Floor,h=i.X0;let a=i.XTube,r=i.TubeHeight,n=0;for(let o=h;o<h+e;o++){o>a+1&&(a+=3+i.XTubeRndValues[n],r=s-i.TubeHeightRndValues[n]-2,n++),a>=h+e-2&&(a+=10);for(let i=0;i<this.Height;i++)if(i>=s)t.SetBlock(o,i,145);else if(i<s&&(o===a||o===a+1)&&i>=r){const e=10+o-a;i===r?t.SetBlock(o,i,e):t.SetBlock(o,i,e+16)}}}BuildStraight(t,i){const e=i.Length,s=i.Floor,h=i.X0;for(let i=h;i<h+e;i++)for(let e=0;e<this.Height;e++)e>=s&&t.SetBlock(i,e,145);null!==i.Decorate&&this.Decorate(t,i.Decorate,s,e,h)}BuildHillStraight(t,i){const e=i.Length,s=i.Floor,h=i.X0;for(let i=h;i<h+e;i++)for(let e=0;e<this.Height;e++)e>=s&&t.SetBlock(i,e,145);let a=s,r=0,n=0,o=[],l=0,d=!0;for(;d&&(a=i.Hrnd[l],!(a<=0))&&(r=i.Lrnd[l],n=i.XXOrnd[l],!(o[n-h]||o[n-h+r]||o[n-h-1]||o[n-h+r+1]));){o[n-h]=!0,o[n-h+r]=!0,l===i.DecorateIteration&&(null!==i.Decorate&&this.Decorate(t,i.Decorate),d=!1);let e=0;for(let h=n;h<n+r;h++)for(let o=a;o<s;o++){let s=5,d=9;h===n&&(s=4),h===n+r-1&&(s=6),o===a&&(d=8);const c=i.Blocks[l][e];0===c?t.SetBlock(h,o,s+16*d):(132===c&&t.SetBlock(h,o,180),134===c&&t.SetBlock(h,o,182)),e++}l++}}BuildCannons(t,i){const e=i.Length,s=i.Floor,h=i.X0;let a=0;for(let r=h;r<h+e;r++){const e=i.XCannon[a],h=i.CannonHeight[a];for(let i=0;i<this.Height;i++)i>=s?t.SetBlock(r,i,145):i<s&&r===e&&i>=h&&(i===h?t.SetBlock(r,i,14):i===h+1?t.SetBlock(r,i,30):t.SetBlock(r,i,46));a++}}Decorate(t,i){let e=i.SBegin,s=i.EBegin;const h=i.X0,a=i.X1,r=i.Floor;if(r-2>0&&a-1-s-(h+1+e)>1)for(let i=h+1+e;i<a-1-s;i++)t.SetBlock(i,r-2,34);e=i.SEnd,s=i.EEnd;let n=0;if(r-4>0&&a-1-s-(h+1+e)>2)for(let o=h+1+e;o<a-1-s;o++){const e=i.Rnd1[n],s=i.Rnd2[n],l=i.Rnd3[n],d=i.Rnd4[n];n++,o!==h+1&&o!==a-2&&0===e?t.SetBlock(o,r-4,0===s?22:21):0===l?t.SetBlock(o,r-4,0===d?18:17):t.SetBlock(o,r-4,16)}}}class SpriteTemplate{constructor(t,i){this.Type=t,this.Winged=i,this.LastVisibleTick=-1,this.IsDead=!1,this.Sprite=null}Spawn(t,i,e,s){this.IsDead||(this.Type===Enemy.Flower?this.Sprite=new FlowerEnemy(t,16*i+15,16*e+24):this.Sprite=new Enemy(t,16*i+8,16*e+15,s,this.Type,this.Winged),this.Sprite.SpriteTemplate=this,t.AddSprite(this.Sprite))}}class Enemy extends NotchSprite{static RedKoopa=0;static GreenKoopa=1;static Goomba=2;static Spiky=3;static Flower=4;constructor(t,i,e,s,h,a){super(),this.GroundInertia=.89,this.AirInertia=.89,this.RunTime=0,this.OnGround=!1,this.MayJump=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.Width=4,this.Height=24,this.DeadTime=0,this.FlyDeath=!1,this.WingTime=0,this.NoFireballDeath=!1,this.X=i,this.Y=e,this.InitX=i,this.InitY=e,this.World=t,this.Type=h,this.Winged=a,this.Image=Engine.Resources.Images.enemies,this.XPicO=8,this.YPicO=31,this.AvoidCliffs=this.Type===Enemy.RedKoopa,this.NoFireballDeath=this.Type===Enemy.Spiky,this.YPic=this.Type,this.YPic>1&&(this.Height=12),this.Facing=s,0===this.Facing&&(this.Facing=1),this.PicWidth=16}CollideCheck(){if(0!==this.DeadTime)return;let t=Mario.MarioCharacter.X-this.X,i=Mario.MarioCharacter.Y-this.Y;if(t>2*-this.Width-4&&t<2*this.Width+4&&i>-this.Height&&i<Mario.MarioCharacter.Height){if(!(this.Type!==Enemy.Spiky&&Mario.MarioCharacter.Ya>0&&i<=0)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround)return void Mario.MarioCharacter.GetHurt();Mario.MarioCharacter.Stomp(this),this.Winged?(this.Winged=!1,this.Ya=0):(this.YPicO=7,this.PicHeight=8,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=10,this.Winged=!1,this.Type===Enemy.RedKoopa?this.World.AddSprite(new Shell(this.World,this.X,this.Y,0)):this.Type===Enemy.GreenKoopa&&this.World.AddSprite(new Shell(this.World,this.X,this.Y,1)))}}Move(){let t=0,i=0;if(this.WingTime++,this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,t=0;t<8;t++)this.World.AddSprite(new Sparkle(this.World,4+(this.X+16*Math.random()-8|0),4+(this.Y-8*Math.random()|0),2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}this.FlyDeath&&(this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1)}else this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=1.75*this.Facing,this.MayJump=this.OnGround,this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,i=(this.RunTime/20|0)%2,this.OnGround||(i=1),this.SubMove(this.Xa,0)||(this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=this.Winged?.95:.85,this.OnGround?this.Xa*=this.GroundInertia:this.Xa*=this.AirInertia,!this.OnGround&&this.Winged?this.Ya+=.6:this.OnGround?this.Winged&&(this.Ya=-10):this.Ya+=2,this.Winged&&(i=(this.WingTime/4|0)%2),this.XPic=i}SubMove(t,i){let e=!1;for(;t>8;){if(!this.SubMove(8,0))return!1;t-=8}for(;t<-8;){if(!this.SubMove(-8,0))return!1;t+=8}for(;i>8;){if(!this.SubMove(0,8))return!1;i-=8}for(;i<-8;){if(!this.SubMove(0,-8))return!1;i+=8}return(i>0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t-this.Width,this.Y+i+1,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i+1,t,i))||i<0&&(this.IsBlocking(this.X+t,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)))&&(e=!0),(t>0&&(this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,i)||this.AvoidCliffs&&this.OnGround&&!this.World.Level.IsBlocking((this.X+this.Xa+this.Width)/16|0,this.Y/16+1|0,this.Xa,1))||t<0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i,t,i)||this.AvoidCliffs&&this.OnGround&&!this.World.Level.IsBlocking((this.X+this.Xa-this.Width)/16|0,this.Y/16+1|0,this.Xa,1)))&&(e=!0),e?(t<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),t>0&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),i<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.JumpTime=0,this.Ya=0),i>0&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=t,this.Y+=i,!0)}IsBlocking(t,i,e,s){return i=i/16|0,!((t=t/16|0)===this.X/16|0&&i===this.Y/16|0)&&this.World.Level.IsBlocking(t,i,e,s)}ShellCollideCheck(t){if(0!==this.DeadTime)return!1;let i=t.X-this.X,e=t.Y-this.Y;return i>-16&&i<16&&e>-this.Height&&e<t.Height&&(Engine.Resources.PlaySound("kick"),this.Xa=2*t.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0,!0)}FireballCollideCheck(t){if(0!==this.DeadTime)return!1;let i=t.X-this.X,e=t.Y-this.Y;return i>-16&&i<16&&e>-this.Height&&e<t.Height?(this.NoFireballDeath||(Engine.Resources.PlaySound("kick"),this.Xa=2*t.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0),!0):void 0}BumpCheck(t,i){0===this.DeadTime&&this.X+this.Width>16*t&&this.X-this.Width<16*t+16&&i===(this.Y-1)/16|0&&(Engine.Resources.PlaySound("kick"),this.Xa=2*-Mario.MarioCharacter.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0)}Draw(t,i){let e=0,s=0;this.Winged&&(e=(this.XOld+(this.X-this.XOld)*this.Delta|0)-this.XPicO,s=(this.YOld+(this.Y-this.YOld)*this.Delta|0)-this.YPicO,this.Type!==Enemy.RedKoopa&&this.Type!==Enemy.GreenKoopa&&(this.XFlip=!this.XFlip,t.save(),t.scale(this.XFlip?-1:1,this.YFlip?-1:1),t.translate(this.XFlip?-320:0,this.YFlip?-240:0),t.drawImage(this.Image,(this.WingTime/4|0)%2*16,128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s-32:s-8,16,32),t.restore(),this.XFlip=!this.XFlip)),super.Draw(t,i),this.Winged&&(e=(this.XOld+(this.X-this.XOld)*this.Delta|0)-this.XPicO,s=(this.YOld+(this.Y-this.YOld)*this.Delta|0)-this.YPicO,this.Type===Enemy.RedKoopa&&this.Type===Enemy.GreenKoopa?(t.save(),t.scale(this.XFlip?-1:1,this.YFlip?-1:1),t.translate(this.XFlip?-320:0,this.YFlip?-240:0),t.drawImage(this.Image,(this.WingTime/4|0)%2*16,128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s:s-8,16,32),t.restore()):(t.save(),t.scale(this.XFlip?-1:1,this.YFlip?-1:1),t.translate(this.XFlip?-320:0,this.YFlip?-240:0),t.drawImage(this.Image,(this.WingTime/4|0)%2*16,128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s-32:s-8,16,32),t.restore()))}}class Fireball extends NotchSprite{constructor(t,i,e,s){super(),this.GroundInertia=.89,this.AirInertia=.89,this.Image=Engine.Resources.Images.particles,this.World=t,this.X=i,this.Y=e,this.Facing=s||1,this.XPicO=4,this.YPicO=4,this.YPic=3,this.XPic=4,this.Height=8,this.Width=4,this.PicWidth=this.PicHeight=8,this.Ya=4,this.Dead=!1,this.DeadTime=0,this.Anim=0,this.OnGround=!1}Move(){let t=0;if(this.DeadTime>0){for(t=0;t<8;t++)this.World.AddSprite(new Sparkle(this.World,4+(this.X+8*Math.random()-4|0),2+(this.Y+8*Math.random()-4|0),2*Math.random()-1*this.Facing,2*Math.random()-1,0,1,5));this.World.RemoveSprite(this)}else 0!=this.Facing&&this.Anim++,this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=8*this.Facing,this.World.CheckFireballCollide(this),this.FlipX=-1===this.Facing,this.XPic=this.Anim%4,this.SubMove(this.Xa,0)||this.Die(),this.OnGround=!1,this.SubMove(0,this.Ya),this.OnGround&&(this.Ya=-10),this.Ya*=.95,this.OnGround?this.Xa*=this.GroundInertia:this.Xa*=this.AirInertia,this.OnGround||(this.Ya+=1.5)}SubMove(t,i){let e=!1;for(;t>8;){if(!this.SubMove(8,0))return!1;t-=8}for(;t<-8;){if(!this.SubMove(-8,0))return!1;t+=8}for(;i>8;){if(!this.SubMove(0,8))return!1;i-=8}for(;i<-8;){if(!this.SubMove(0,-8))return!1;i+=8}return(i>0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t-this.Width,this.Y+i+1,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i+1,t,i))||i<0&&(this.IsBlocking(this.X+t,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)))&&(e=!0),(t>0&&(this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,i))||t<0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i,t,i)))&&(e=!0),e?(t<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),t>0&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),i<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.Ya=0),i>0&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=t,this.Y+=i,!0)}IsBlocking(t,i,e,s){return i=i/16|0,!((t=t/16|0)===this.X/16|0&&i===this.Y/16|0)&&this.World.Level.IsBlocking(t,i,e,s)}Die(){this.Dead=!0,this.Xa=2*-this.Facing,this.Ya=-5,this.DeadTime=100}}class Sparkle extends NotchSprite{constructor(t,i,e,s,h){super(),this.World=t,this.X=i,this.Y=e,this.Xa=s,this.Ya=h,this.XPic=2*Math.random()|0,this.YPic=0,this.Life=10+(5*Math.random()|0),this.XPicStart=this.XPic,this.XPicO=4,this.YPicO=4,this.PicWidth=8,this.PicHeight=8,this.Image=Engine.Resources.Images.particles}Move(){this.Life>10?this.XPic=7:this.XPic=this.XPicStart+.4*(10-this.Life)|0,this.Life--<0&&this.World.RemoveSprite(this),this.X+=this.Xa,this.Y+=this.Ya}}class CoinAnim extends NotchSprite{constructor(t,i,e){super(),this.World=t,this.Life=10,this.Image=Engine.Resources.Images.map,this.PicWidth=this.PicHeight=16,this.X=16*i,this.Y=16*e-16,this.Xa=0,this.Ya=-6,this.XPic=0,this.YPic=2}Move(){let t=0,i=0;if(this.Life--<0)for(this.World.RemoveSprite(this),t=0;t<2;t++)for(i=0;i<2;i++)this.World.AddSprite(new Sparkle(this.World,this.X+8*t+8*Math.random()|0,this.Y+8*i+8*Math.random()|0,0,0,0,2,5));this.XPic=3&this.Life,this.X+=this.Xa,this.Y+=this.Ya,this.Ya+=1}}class Mushroom extends NotchSprite{constructor(t,i,e){super(),this.RunTime=0,this.GroundInertia=.89,this.AirInertia=.89,this.OnGround=!1,this.Width=4,this.Height=24,this.World=t,this.X=i,this.Y=e,this.InitX=i,this.InitY=e,this.Image=Engine.Resources.Images.items,this.XPicO=8,this.YPicO=15,this.YPic=0,this.Height=12,this.Facing=1,this.PicWidth=this.PicHeight=16,this.Life=0}CollideCheck(){let t=Mario.MarioCharacter.X-this.X,i=Mario.MarioCharacter.Y-this.Y;t>-16&&t<16&&i>-this.Height&&i<Mario.MarioCharacter.Height&&(Mario.MarioCharacter.GetMushroom((this.InitX-8)/16,(this.InitY-8)/16),this.World.RemoveSprite(this))}Move(){if(this.Life<9)return this.Layer=0,this.Y--,void this.Life++;this.Layer=1,this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=1.75*this.Facing,this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,this.SubMove(this.Xa,0)||(this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=.85,this.OnGround?this.Xa*=this.GroundInertia:this.Xa*=this.AirInertia,this.OnGround||(this.Ya+=2)}SubMove(t,i){let e=!1;for(;t>8;){if(!this.SubMove(8,0))return!1;t-=8}for(;t<-8;){if(!this.SubMove(-8,0))return!1;t+=8}for(;i>8;){if(!this.SubMove(0,8))return!1;i-=8}for(;i<-8;){if(!this.SubMove(0,-8))return!1;i+=8}return(i>0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t-this.Width,this.Y+i+1,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i+1,t,i))||i<0&&(this.IsBlocking(this.X+t,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)))&&(e=!0),(t>0&&(this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,i))||t<0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i,t,i)))&&(e=!0),e?(t<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),t>0&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),i<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.JumpTime=0,this.Ya=0),i>0&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=t,this.Y+=i,!0)}IsBlocking(t,i,e,s){return i=i/16|0,!((t=t/16|0)===this.X/16|0&&i===this.Y/16|0)&&this.World.Level.IsBlocking(t,i,e,s)}BumpCheck(t,i){this.X+this.Width>16*t&&this.X-this.Width<16*t-16&&i===(i-1)/16|0&&(this.Facing=-Mario.MarioCharacter.Facing,this.Ya=-10)}}class Particle extends NotchSprite{constructor(t,i,e,s,h,a,r){super(),this.World=t,this.X=i,this.Y=e,this.Xa=s,this.Ya=h,this.XPic=2*Math.random()|0,this.YPic=0,this.XPicO=4,this.YPicO=4,this.PicWidth=8,this.PicHeight=8,this.Life=10,this.Image=Engine.Resources.Images.particles}Move(){this.Life-this.Delta<0&&this.World.RemoveSprite(this),this.Life-=this.Delta,this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=3}}class FireFlower extends NotchSprite{constructor(t,i,e){super(),this.Width=4,this.Height=24,this.World=t,this.X=i,this.Y=e,this.InitX=i,this.InitY=e,this.Image=Engine.Resources.Images.items,this.XPicO=8,this.YPicO=15,this.XPic=1,this.YPic=0,this.Height=12,this.Facing=1,this.PicWidth=this.PicHeight=16,this.Life=0}CollideCheck(){let t=Mario.MarioCharacter.X-this.X,i=Mario.MarioCharacter.Y-this.Y;t>-16&&t<16&&i>-this.Height&&i<Mario.MarioCharacter.Height&&(Mario.MarioCharacter.GetFlower((this.InitX-8)/16,(this.InitY-8)/16),this.World.RemoveSprite(this))}Move(){this.Life>=9||(this.Layer=0,this.Y--,this.Life++)}}class BulletBill extends NotchSprite{constructor(t,i,e,s){super(),this.Image=Engine.Resources.Images.enemies,this.World=t,this.X=i,this.Y=e,this.Facing=s,this.XPicO=8,this.YPicO=31,this.Height=12,this.Width=4,this.PicWidth=16,this.YPic=5,this.XPic=0,this.Ya=-5,this.DeadTime=0,this.Dead=!1,this.Anim=0}CollideCheck(){if(this.Dead)return;let t=Mario.MarioCharacter.X-this.X,i=Mario.MarioCharacter.Y-this.Y;t>-16&&t<16&&i>-this.Height&&i<Mario.MarioCharacter.Height&&(!(Mario.MarioCharacter.Y>0&&i<=0)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Stomp(this),this.Dead=!0,this.Xa=0,this.Ya=1,this.DeadTime=100))}Move(){let t=0;if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,t=0;t<8;t++)this.World.AddSprite(new Sparkle(4+(this.X+16*Math.random()-8|0),4+(this.Y+8*Math.random()|0),2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,void(this.Ya+=1)}this.Xa=4*this.Facing,this.XFlip=-1===this.Facing,this.SubMove(this.Xa,0)}SubMove(t,i){return this.X+=t,!0}FireballCollideCheck(t){if(0!==this.DeadTime)return!1;let i=t.X-this.X,e=t.Y-this.Y;return i>-16&&i<16&&e>-this.Height&&e<t.Height}ShellCollideCheck(t){if(0!==this.DeadTime)return!1;let i=t.X-this.X,e=t.Y-this.Y;return i>-16&&i<16&&e>-this.Height&&e<t.Height&&(Engine.Resources.PlaySound("kick"),this.Dead=!0,this.Xa=0,this.Ya=1,this.DeadTime=100,!0)}}class FlowerEnemy extends Enemy{constructor(t,i,e){super(),this.Image=Engine.Resources.Images.enemies,this.World=t,this.X=i,this.Y=e,this.Facing=1,this.Type=Enemy.Spiky,this.Winged=!1,this.NoFireballDeath=!1,this.XPic=0,this.YPic=6,this.YPicO=24,this.Height=12,this.Width=2,this.YStart=e,this.Ya=-8,this.Y-=1,this.Layer=0,this.JumpTime=0,this.Tick=0;for(let t=0;t<4;t++)this.Move()}Move(){let t=0,i=0;if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,t=0;t<8;t++)this.World.AddSprite(new Sparkle(4+(this.X+16*Math.random()-8|0),4+(this.Y+8*Math.random()|0),2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,void(this.Ya+=1)}this.Tick++,this.Y>=this.YStart?(this.YStart=this.Y,i=0|Math.abs(Mario.MarioCharacter.X-this.X),this.JumpTime++,this.JumpTime>40&&i>24?this.Ya=-8:this.Ya=0):this.JumpTime=0,this.Y+=this.Ya,this.Ya*=.9,this.Ya+=.1,this.XPic=2*(1&(this.Tick/2|0))+(1&(this.Tick/6|0))}}class Shell extends NotchSprite{constructor(t,i,e,s){super(),this.World=t,this.X=i,this.Y=e,this.YPic=s,this.Image=Engine.Resources.Images.enemies,this.XPicO=8,this.YPicO=31,this.Width=4,this.Height=12,this.Facing=0,this.PicWidth=16,this.XPic=4,this.Ya=-5,this.Dead=!1,this.DeadTime=0,this.Carried=!1,this.GroundInertia=.89,this.AirInertia=.89,this.OnGround=!1,this.Anim=0}FireballCollideCheck(t){if(0!==this.DeadTime)return!1;let i=t.X-this.X,e=t.Y-this.Y;return i>-16&&i<16&&e>-this.Height&&e<t.Height&&(0!==this.Facing||(Engine.Resources.PlaySound("kick"),this.Xa=2*t.Facing,this.Ya=-5,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.YFlip=!0),!0)}CollideCheck(){if(this.Carried||this.Dead||this.DeadTime>0)return;let t=Mario.MarioCharacter.X-this.X,i=Mario.MarioCharacter.Y-this.Y;t>-16&&t<16&&i>-this.Height&&i<Mario.MarioCharacter.Height&&(!(Mario.MarioCharacter.Ya>0&&i<=0)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?0!==this.Facing?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Kick(this),this.Facing=Mario.MarioCharacter.Facing):(Mario.MarioCharacter.Stomp(this),0!==this.Facing?(this.Xa=0,this.Facing=0):this.Facing=Mario.MarioCharacter.Facing))}Move(){let t=0;if(this.Carried)this.World.CheckShellCollide(this);else{if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,t=0;t<8;t++)this.World.AddSprite(new Sparkle(4+(this.X+16*Math.random()-8|0),4+(this.Y+8*Math.random()|0),2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,void(this.Ya+=1)}0!==this.Facing&&this.Anim++,this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=11*this.Facing,0!==this.Facing&&this.World.CheckShellCollide(this),this.XFlip=-1===this.Facing,this.XPic=(this.Anim/2|0)%4+3,this.SubMove(this.Xa,0)||(Engine.Resources.PlaySound("bump"),this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=.85,this.OnGround?this.Xa*=this.GroundInertia:this.Xa*=this.AirInertia,this.OnGround||(this.Ya+=2)}}SubMove(t,i){let e=!1;for(;t>8;){if(!this.SubMove(8,0))return!1;t-=8}for(;t<-8;){if(!this.SubMove(-8,0))return!1;t+=8}for(;i>8;){if(!this.SubMove(0,8))return!1;i-=8}for(;i<-8;){if(!this.SubMove(0,-8))return!1;i+=8}return(i>0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,0)||this.IsBlocking(this.X+t-this.Width,this.Y+i+1,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i+1,t,i))||i<0&&(this.IsBlocking(this.X+t,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i))||t>0&&(this.IsBlocking(this.X+t+this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t+this.Width,this.Y+i,t,i))||t<0&&(this.IsBlocking(this.X+t-this.Width,this.Y+i-this.Height,t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i-(this.Height/2|0),t,i)||this.IsBlocking(this.X+t-this.Width,this.Y+i,t,i)))&&(e=!0),e?(t<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),t>0&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),i<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.Ya=0),i>0&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=t,this.Y+=i,!0)}IsBlocking(t,i,e,s){if(i=i/16|0,(t=t/16|0)===(this.X/16|0)&&i===(this.Y/16|0))return!1;let h=this.World.Level.IsBlocking(t,i,e,s);return h&&0===s&&0!==e&&this.World.Bump(t,i,!0),h}BumpCheck(t,i){this.X+this.Width>16*t&&this.X-this.Width<16*t+16&&i===((this.Y-1)/16|0)&&(this.Facing=-Mario.MarioCharacter.Facing,this.Ya=-10)}Die(){this.Dead=!0,this.Carried=!1,this.Xa=2*-this.Facing,this.Ya=-5,this.DeadTime=100}ShellCollideCheck(t){if(0!==this.DeadTime)return!1;let i=t.X-this.X,e=t.Y-this.Y;return i>-16&&i<16&&e>-this.Height&&e<t.Height&&(Engine.Resources.PlaySound("kick"),Mario.MarioCharacter.Carried!==t&&Mario.MarioCharacter.Carried!==this||(Mario.MarioCharacter.Carried=null),this.Die(),t.Die(),!0)}Release(t){this.Carried=!1,this.Facing=Mario.MarioCharacter.Facing,this.X+=8*this.Facing}}class TitleState extends Engine.GameState{constructor(){super(),this.drawManager=null,this.camera=null,this.logoY=null,this.bounce=null,this.font=null}Enter(){this.drawManager=new Engine.DrawableManager,this.camera=new Engine.Camera;let t=new BackgroundGenerator(2048,15,!0,LevelType.Overground),i=new BackgroundRenderer(t.CreateLevel(),320,240,2);t.SetValues(2048,15,!1,LevelType.Overground);let e=new BackgroundRenderer(t.CreateLevel(),320,240,1);this.title=new Engine.Sprite,this.title.Image=Engine.Resources.Images.title,this.title.X=0,this.title.Y=120,this.logo=new Engine.Sprite,this.logo.Image=Engine.Resources.Images.logo,this.logo.X=0,this.logo.Y=0,this.font=SpriteCuts.CreateRedFont(),this.font.Strings[0]={String:"Press S to Start",X:96,Y:120},this.logoY=20,this.drawManager.Add(i),this.drawManager.Add(e),this.bounce=0,Mario.GlobalMapState=new MapState,Mario.MarioCharacter=new Character,Mario.MarioCharacter.Image=Engine.Resources.Images.smallMario}Exit(){this.drawManager.Clear(),delete this.drawManager,delete this.camera,delete this.font}Update(t){this.bounce+=2*t,this.logoY=20+10*Math.sin(this.bounce),this.camera.X+=25*t,this.drawManager.Update(t)}Draw(t){this.drawManager.Draw(t,this.camera),t.drawImage(Engine.Resources.Images.title,0,120),t.drawImage(Engine.Resources.Images.logo,0,this.logoY),this.font.Draw(t,this.Camera)}CheckForChange(t){Engine.KeyboardInput.IsKeyDown(Engine.Keys.S)&&t.ChangeState(Mario.GlobalMapState)}}class LoadingState extends Engine.GameState{constructor(){super(),this.Images=[],this.ImagesLoaded=!1,this.ScreenColor=0,this.ColorDirection=1,this.ImageIndex=0,this.SoundIndex=0}Enter(){this.Images=[{name:"background",src:"images/bgsheet.png"},{name:"endScene",src:"images/endscene.gif"},{name:"enemies",src:"images/enemysheet.png"},{name:"fireMario",src:"images/firemariosheet.png"},{name:"font",src:"images/font.gif"},{name:"gameOverGhost",src:"images/gameovergost.gif"},{name:"items",src:"images/itemsheet.png"},{name:"logo",src:"images/logo.gif"},{name:"map",src:"images/mapsheet.png"},{name:"mario",src:"images/mariosheet.png"},{name:"particles",src:"images/particlesheet.png"},{name:"racoonMario",src:"images/racoonmariosheet.png"},{name:"smallMario",src:"images/smallmariosheet.png"},{name:"title",src:"images/title.gif"},{name:"worldMap",src:"images/worldmap.png"}],Engine.Resources.AddImages(this.Images),(new Audio).canPlayType("audio/mp3")?Engine.Resources.AddSound("1up","sounds/1-up.mp3",1).AddSound("breakblock","sounds/breakblock.mp3").AddSound("bump","sounds/bump.mp3",4).AddSound("cannon","sounds/cannon.mp3").AddSound("coin","sounds/coin.mp3",5).AddSound("death","sounds/death.mp3",1).AddSound("exit","sounds/exit.mp3",1).AddSound("fireball","sounds/fireball.mp3",1).AddSound("jump","sounds/jump.mp3").AddSound("kick","sounds/kick.mp3").AddSound("pipe","sounds/pipe.mp3",1).AddSound("powerdown","sounds/powerdown.mp3",1).AddSound("powerup","sounds/powerup.mp3",1).AddSound("sprout","sounds/sprout.mp3",1).AddSound("stagestart","sounds/stagestart.mp3",1).AddSound("stomp","sounds/stomp.mp3",2):Engine.Resources.AddSound("1up","sounds/1-up.wav",1).AddSound("breakblock","sounds/breakblock.wav").AddSound("bump","sounds/bump.wav",2).AddSound("cannon","sounds/cannon.wav").AddSound("coin","sounds/coin.wav",5).AddSound("death","sounds/death.wav",1).AddSound("exit","sounds/exit.wav",1).AddSound("fireball","sounds/fireball.wav",1).AddSound("jump","sounds/jump.wav",1).AddSound("kick","sounds/kick.wav",1).AddSound("message","sounds/message.wav",1).AddSound("pipe","sounds/pipe.wav",1).AddSound("powerdown","sounds/powerdown.wav",1).AddSound("powerup","sounds/powerup.wav",1).AddSound("sprout","sounds/sprout.wav",1).AddSound("stagestart","sounds/stagestart.wav",1).AddSound("stomp","sounds/stomp.wav",1),Tile.LoadBehaviors()}Exit(){delete this.Images}Update(t){if(!this.ImagesLoaded){this.ImagesLoaded=!0;let t=0;for(t=0;t<this.Images.length;t++)if(!0!==Engine.Resources.Images[this.Images[t].name].complete){this.ImagesLoaded=!1;break}}this.ScreenColor+=255*this.ColorDirection*t,this.ScreenColor>255?(this.ScreenColor=255,this.ColorDirection=-1):this.ScreenColor<0&&(this.ScreenColor=0,this.ColorDirection=1)}Draw(t){if(this.ImagesLoaded)t.fillStyle="rgb(0, 0, 0)",t.fillRect(0,0,640,480);else{var i=parseInt(this.ScreenColor,10);t.fillStyle="rgb("+i+","+i+","+i+")",t.fillRect(0,0,640,480)}}CheckForChange(t){this.ImagesLoaded&&(Mario.GlobalMapState=new MapState,t.ChangeState(new PredefinedTitleState))}}class LoseState extends Engine.GameState{constructor(){super(),this.drawManager=null,this.camera=null,this.gameOver=null,this.font=null,this.wasKeyDown=!1}Enter(){this.drawManager=new Engine.DrawableManager,this.camera=new Engine.Camera,this.gameOver=new Engine.AnimatedSprite,this.gameOver.Image=Engine.Resources.Images.gameOverGhost,this.gameOver.SetColumnCount(9),this.gameOver.SetRowCount(1),this.gameOver.AddNewSequence("turnLoop",0,0,0,8),this.gameOver.PlaySequence("turnLoop",!0),this.gameOver.FramesPerSecond=1/15,this.gameOver.X=112,this.gameOver.Y=68,this.font=SpriteCuts.CreateBlackFont(),this.font.Strings[0]={String:"Game over!",X:116,Y:160},this.drawManager.Add(this.font),this.drawManager.Add(this.gameOver)}Exit(){this.drawManager.Clear(),delete this.drawManager,delete this.camera,delete this.gameOver,delete this.font}Update(t){this.drawManager.Update(t),Engine.KeyboardInput.IsKeyDown(Engine.Keys.S)&&(this.wasKeyDown=!0)}Draw(t){this.drawManager.Draw(t,this.camera)}CheckForChange(t){this.wasKeyDown&&!Engine.KeyboardInput.IsKeyDown(Engine.Keys.S)&&t.ChangeState(new PredefinedTitleState)}}class WinState extends Engine.GameState{constructor(){super(),this.waitTime=2,this.drawManager=null,this.camera=null,this.font=null,this.kissing=null,this.wasKeyDown=!1}Enter(){this.drawManager=new Engine.DrawableManager,this.camera=new Engine.Camera,this.font=SpriteCuts.CreateBlackFont(),this.font.Strings[0]={String:"Thank you for saving me, Mario!",X:36,Y:160},this.kissing=new Engine.AnimatedSprite,this.kissing.Image=Engine.Resources.Images.endScene,this.kissing.X=112,this.kissing.Y=52,this.kissing.SetColumnCount(2),this.kissing.SetRowCount(1),this.kissing.AddNewSequence("loop",0,0,0,1),this.kissing.PlaySequence("loop",!0),this.kissing.FramesPerSecond=.5,this.waitTime=2,this.drawManager.Add(this.font),this.drawManager.Add(this.kissing)}Exit(){this.drawManager.Clear(),delete this.drawManager,delete this.camera}Update(t){this.drawManager.Update(t),this.waitTime>0?this.waitTime-=t:Engine.KeyboardInput.IsKeyDown(Engine.Keys.S)&&(this.wasKeyDown=!0)}Draw(t){this.drawManager.Draw(t,this.camera)}CheckForChange=function(t){this.waitTime<=0&&this.wasKeyDown&&!Engine.KeyboardInput.IsKeyDown(Engine.Keys.S)&&t.ChangeState(new PredefinedTitleState)}}class MapTile{static Grass=0;static Water=1;static Level=2;static Road=3;static Decoration=4}class MapState extends Engine.GameState{constructor(){super(),this.camera=new Engine.Camera,this.Level=[],this.Data=[],this.XMario=0,this.YMario=0,this.XMarioA=0,this.YMarioA=0,this.MoveTime=0,this.LevelId=0,this.Farthest=0,this.XFarthestCap=0,this.YFarthestCap=0,this.MapImage=document.createElement("canvas"),this.MapImage.width=320,this.MapImage.height=240,this.MapContext=this.MapImage.getContext("2d"),this.CanEnterLevel=!1,this.EnterLevel=!1,this.LevelDifficulty=0,this.LevelType=0,this.WorldNumber=-1,this.NextWorld()}CreateAnimatedSprite(t,i,e,s,h,a,r,n){let o=new Engine.AnimatedSprite;o.Image=Engine.Resources.Images[t],o.SetColumnCount(i),o.SetRowCount(e);for(let t=0;t<s.length;t++)o.AddNewSequence(s[t].name,s[t].sRow,s[t].sCol,s[t].eRow,s[t].eCol);return o.FramesPerSecond=h,o.PlaySequence(a,!0),o.X=r,o.Y=n,o}Enter(){this.WaterSprite=this.CreateAnimatedSprite("worldMap",16,16,[{name:"loop",sRow:14,sCol:0,eRow:14,eCol:3}],1/3,"loop",0,0),this.DecoSprite=this.CreateAnimatedSprite("worldMap",16,16,[{name:"world0",sRow:10,sCol:0,eRow:10,eCol:3},{name:"world1",sRow:11,sCol:0,eRow:11,eCol:3},{name:"world2",sRow:12,sCol:0,eRow:12,eCol:3},{name:"world3",sRow:13,sCol:0,eRow:13,eCol:3}],1/3,"world0",0,0),this.HelpSprite=this.CreateAnimatedSprite("worldMap",16,16,[{name:"help",sRow:7,sCol:3,eRow:7,eCol:5}],.5,"help",0,0),this.SmallMario=this.CreateAnimatedSprite("worldMap",16,16,[{name:"small",sRow:1,sCol:0,eRow:1,eCol:1}],1/3,"small",0,0),this.LargeMario=this.CreateAnimatedSprite("worldMap",16,8,[{name:"large",sRow:0,sCol:2,eRow:0,eCol:3},{name:"fire",sRow:0,sCol:4,eRow:0,eCol:5}],1/3,"large",0,0),this.FontShadow=SpriteCuts.CreateBlackFont(),this.Font=SpriteCuts.CreateWhiteFont(),this.DecoSprite.PlaySequence("world"+this.WorldNumber%4,!0),this.LargeMario.PlaySequence(Mario.MarioCharacter.Fire?"fire":"large",!0),this.EnterLevel=!1,this.LevelDifficulty=0,this.LevelType=0}Exit(){delete this.WaterSprite,delete this.DecoSprite,delete this.HelpSprite,delete this.SmallMario,delete this.LargeMario,delete this.FontShadow,delete this.Font}NextWorld(){let t=!1;if(this.WorldNumber++,8!==this.WorldNumber){for(this.MoveTime=0,this.LevelId=0,this.Farthest=0,this.XFarthestCap=0,this.YFarthestCap=0;!t;)t=this.GenerateLevel();this.RenderStatic()}}GenerateLevel(){let t=0,i=0,e=0,s=0,h=0,a=0,r=new ImprovedNoise(0x8000000000000000*Math.random()|0),n=new ImprovedNoise(0x8000000000000000*Math.random()|0),o=new ImprovedNoise(0x8000000000000000*Math.random()|0);this.Level=[],this.Data=[];let l=512*Math.random(),d=512*Math.random(),c=512*Math.random(),u=512*Math.random();for(t=0;t<21;t++)for(this.Level[t]=[],this.Data[t]=[],i=0;i<16;i++)e=r.PerlinNoise(10*t+l,10*i+d),s=n.PerlinNoise(10*t+c,10*i+u),h=e-s,a=2*h,this.Level[t][i]=a>0?MapTile.Water:MapTile.Grass;let g=9999,p=9999,m=0;for(a=0,m=0;m<100&&a<12;m++)t=3*(6*Math.random()|0)+2,i=3*(5*Math.random()|0)+1,this.Level[t][i]===MapTile.Grass&&(t<g&&(g=t,p=i),this.Level[t][i]=MapTile.Level,this.Data[t][i]=-1,a++);this.Data[g][p]=-2;let S=!0;for(;S;)S=this.FindConnection(21,16);if(this.FindCaps(21,16),0===this.XFarthestCap)return!1;for(this.Data[this.XFarthestCap][this.YFarthestCap]=-2,this.Data[this.XMario/16|0][this.YMario/16|0]=-11,t=0;t<21;t++)for(i=0;i<16;i++)this.Level[t][i]!==MapTile.Grass||t===this.XFarthestCap&&i===this.YFarthestCap-1||(e=o.PerlinNoise(10*t+l,10*i+d),e>0&&(this.Level[t][i]=MapTile.Decoration));return!0}FindConnection(t,i){let e=0,s=0;for(e=0;e<t;e++)for(s=0;s<i;s++)if(this.Level[e][s]===MapTile.Level&&-1===this.Data[e][s])return this.Connect(e,s,t,i),!0;return!1}Connect(t,i,e,s){let h=1e4,a=0,r=0,n=0,o=0,l=0,d=0,c=0;for(n=0;n<e;n++)for(o=0;o<s;o++)this.Level[n][o]===MapTile.Level&&-2===this.Data[n][o]&&(l=0|Math.abs(t-n),d=0|Math.abs(i-o),c=l*l+d*d,c<h&&(a=n,r=o,h=c));this.DrawRoad(t,i,a,r),this.Level[t][i]=MapTile.Level,this.Data[t][i]=-2}DrawRoad(t,i,e,s){let h=!1;if(Math.random()>.5&&(h=!0),h){for(;t>e;)this.Data[t][i]=0,this.Level[t--][i]=MapTile.Road;for(;t<e;)this.Data[t][i]=0,this.Level[t++][i]=MapTile.Road}for(;i>s;)this.Data[t][i]=0,this.Level[t][i--]=MapTile.Road;for(;i<s;)this.Data[t][i]=0,this.Level[t][i++]=MapTile.Road;if(!h){for(;t>e;)this.Data[t][i]=0,this.Level[t--][i]=MapTile.Road;for(;t<e;)this.Data[t][i]=0,this.Level[t++][i]=MapTile.Road}}FindCaps(t,i){let e=0,s=0,h=-1,a=-1,r=0,n=0,o=0;for(e=0;e<t;e++)for(s=0;s<i;s++)if(this.Level[e][s]===MapTile.Level){for(r=0,n=e-1;n<=e+1;n++)for(o=s-1;o<=s+1;o++)this.Level[n][o]===MapTile.Road&&r++;1===r?(-1===h&&(h=e,a=s),this.Data[e][s]=0):this.Data[e][s]=1}this.XMario=16*h,this.YMario=16*a,this.Travel(h,a,-1,0)}Travel(t,i,e,s){if(this.Level[t][i]===MapTile.Road||this.Level[t][i]===MapTile.Level){if(this.Level[t][i]===MapTile.Road){if(1===this.Data[t][i])return;this.Data[t][i]=1}this.Level[t][i]===MapTile.Level&&(this.Data[t][i]>0?0!==this.LevelId&&0==(4*Math.random()|0)?this.Data[t][i]=-3:this.Data[t][i]=++this.LevelId:s>0&&(this.Data[t][i]=-1,s>this.Farthest&&(this.Farthest=s,this.XFarthestCap=t,this.YFarthestCap=i))),2!==e&&this.Travel(t-1,i,0,s++),3!==e&&this.Travel(t,i-1,1,s++),0!==e&&this.Travel(t+1,i,2,s++),1!==e&&this.Travel(t,i+1,3,s++)}}RenderStatic(){let t=0,i=0,e=0,s=0,h=0,a=0,r=0,n=0,o=0,l=Engine.Resources.Images.worldMap,d=0;for(t=0;t<20;t++)for(i=0;i<15;i++)if(this.MapContext.drawImage(l,16*(this.WorldNumber/4|0),0,16,16,16*t,16*i,16,16),this.Level[t][i]===MapTile.Level)d=this.Data[t][i],0===d?this.MapContext.drawImage(l,0,112,16,16,16*t,16*i,16,16):-1===d?this.MapContext.drawImage(l,48,128,16,16,16*t,16*i,16,16):-3===d?this.MapContext.drawImage(l,0,128,16,16,16*t,16*i,16,16):-10===d?this.MapContext.drawImage(l,16,128,16,16,16*t,16*i,16,16):-11===d?this.MapContext.drawImage(l,16,112,16,16,16*t,16*i,16,16):-2===d?(this.MapContext.drawImage(l,32,112,16,16,16*t,16*(i-1),16,16),this.MapContext.drawImage(l,32,128,16,16,16*t,16*i,16,16)):this.MapContext.drawImage(l,16*(d-1),96,16,16,16*t,16*i,16,16);else if(this.Level[t][i]===MapTile.Road)e=this.IsRoad(t-1,i)?1:0,s=this.IsRoad(t,i-1)?1:0,h=this.IsRoad(t+1,i)?1:0,a=this.IsRoad(t,i+1)?1:0,r=e+2*s+4*h+8*a,this.MapContext.drawImage(l,16*r,32,16,16,16*t,16*i,16,16);else if(this.Level[t][i]===MapTile.Water)for(n=0;n<2;n++)for(o=0;o<2;o++)e=this.IsWater(2*t+(n-1),2*i+(o-1))?0:1,s=this.IsWater(2*t+n,2*i+(o-1))?0:1,h=this.IsWater(2*t+(n-1),2*i+o)?0:1,a=this.IsWater(2*t+n,2*i+o)?0:1,r=e+2*s+4*h+8*a-1,r>=0&&r<=14&&this.MapContext.drawImage(l,16*r,16*(4+(n+o&1)),16,16,16*t+8*n,16*i+8*o,16,16)}IsRoad(t,i){return t<0&&(t=0),i<0&&(i=0),this.Level[t][i]===MapTile.Road||this.Level[t][i]===MapTile.Level}IsWater(t,i){t<0&&(t=0),i<0&&(i=0);for(let e=0;e<2;e++)for(let s=0;s<2;s++)if(this.Level[(t+e)/2|0][(i+s)/2|0]!==MapTile.Water)return!1;return!0}Update(t){if(8===this.WorldNumber)return;this.XMario+=this.XMarioA,this.YMario+=this.YMarioA;let i=this.XMario/16|0,e=this.YMario/16|0,s=0,h=0;this.Level[i][e]===MapTile.Road&&(this.Data[i][e]=0),this.MoveTime>0?this.MoveTime--:(this.XMarioA=0,this.YMarioA=0,this.CanEnterLevel&&Engine.KeyboardInput.IsKeyDown(Engine.Keys.S)&&this.Level[i][e]===MapTile.Level&&-11!==this.Data[i][e]&&this.Level[i][e]===MapTile.Level&&0!==this.Data[i][e]&&this.Data[i][e]>-10&&(s=this.WorldNumber+1,Mario.MarioCharacter.LevelString=s+"-",h=LevelType.Overground,this.Data[i][e]>1&&0==(3*Math.random()|0)&&(h=LevelType.Underground),this.Data[i][e]<0?(-2===this.Data[i][e]?(Mario.MarioCharacter.LevelString+="X",s+=2):-1===this.Data[i][e]?Mario.MarioCharacter.LevelString+="?":(Mario.MarioCharacter.LevelString+="#",s+=1),h=LevelType.Castle):Mario.MarioCharacter.LevelString+=this.Data[i][e],this.EnterLevel=!0,this.LevelDifficulty=s,this.LevelType=h),this.CanEnterLevel=!Engine.KeyboardInput.IsKeyDown(Engine.Keys.S),Engine.KeyboardInput.IsKeyDown(Engine.Keys.Left)&&this.TryWalking(-1,0),Engine.KeyboardInput.IsKeyDown(Engine.Keys.Right)&&this.TryWalking(1,0),Engine.KeyboardInput.IsKeyDown(Engine.Keys.Up)&&this.TryWalking(0,-1),Engine.KeyboardInput.IsKeyDown(Engine.Keys.Down)&&this.TryWalking(0,1)),this.WaterSprite.Update(t),this.DecoSprite.Update(t),this.HelpSprite.Update(t),Mario.MarioCharacter.Large?(this.LargeMario.X=this.XMario+this.XMarioA*t|0,this.LargeMario.Y=this.YMario+(this.YMarioA*t|0)-22,this.LargeMario.Update(t)):(this.SmallMario.X=this.XMario+this.XMarioA*t|0,this.SmallMario.Y=this.YMario+(this.YMarioA*t|0)-6,this.SmallMario.Update(t))}TryWalking(t,i){let e=this.XMario/16|0,s=this.YMario/16|0,h=e+t,a=s+i;if(this.Level[h][a]===MapTile.Road||this.Level[h][a]===MapTile.Level){if(this.Level[h][a]===MapTile.Road&&0!==this.Data[h][a]&&0!==this.Data[e][s]&&this.Data[e][s]>-10)return;this.XMarioA=8*t,this.YMarioA=8*i,this.MoveTime=2*this.CalcDistance(e,s,t,i)+1}}CalcDistance(t,i,e,s){let h=0;for(;;){if(t+=e,i+=s,this.Level[t][i]!==MapTile.Road)return h;if(this.Level[t-s][i+e]===MapTile.Road)return h;if(this.Level[t+s][i-e]===MapTile.Road)return h;h++}}Draw(t){let i=0,e=0;if(8!==this.WorldNumber){for(t.drawImage(this.MapImage,0,0),e=0;e<=15;e++)for(i=20;i>=0;i--)this.Level[i][e]===MapTile.Water&&this.IsWater(2*i-1,2*e-1)?(this.WaterSprite.X=16*i-8,this.WaterSprite.Y=16*e-8,this.WaterSprite.Draw(t,this.camera)):this.Level[i][e]===MapTile.Decoration?(this.DecoSprite.X=16*i,this.DecoSprite.Y=16*e,this.DecoSprite.Draw(t,this.camera)):this.Level[i][e]===MapTile.Level&&-2===this.Data[i][e]&&(this.HelpSprite.X=16*i+16,this.HelpSprite.Y=16*e-16,this.HelpSprite.Draw(t,this.camera));Mario.MarioCharacter.Large?this.LargeMario.Draw(t,this.camera):this.SmallMario.Draw(t,this.camera),this.Font.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:4,Y:4},this.FontShadow.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:5,Y:5},this.Font.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:256,Y:4},this.FontShadow.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:257,Y:5},this.FontShadow.Draw(t,this.camera),this.Font.Draw(t,this.camera)}}LevelWon(){let t=this.XMario/16,i=this.YMario/16;-2!==this.Data[t][i]?(-3!==this.Data[t][i]?this.Data[t][i]=0:this.Data[t][i]=-10,this.RenderStatic()):this.NextWorld()}GetX(){return 160}GetY(){return 120}CheckForChange(t){8===this.WorldNumber&&t.ChangeState(new WinState),this.EnterLevel&&t.ChangeState(new LevelState(this.LevelDifficulty,this.LevelType))}}class LevelState extends Engine.GameState{constructor(t,i){super(),this.LevelDifficulty=t,this.LevelType=i,this.Level=null,this.Layer=null,this.BgLayer=[],this.Paused=!1,this.Sprites=null,this.SpritesToAdd=null,this.SpritesToRemove=null,this.Camera=null,this.ShellsToCheck=null,this.FireballsToCheck=null,this.FontShadow=null,this.Font=null,this.TimeLeft=0,this.StartTime=0,this.FireballsOnScreen=0,this.Tick=0,this.Delta=0,this.GotoMapState=!1,this.GotoLoseState=!1,Mario.MarioCharacter.gameplayMetrics.SetLevelState(this)}GetName(){return"LevelState"}GetLevel(){return new LevelGenerator(320,15).CreateLevel(this.LevelType,this.LevelDifficulty)}Enter(){this.Level=this.GetLevel(),this.Paused=!1,this.Layer=new LevelRenderer(this.Level,320,240),this.Sprites=new Engine.DrawableManager,this.Camera=new Engine.Camera,this.Tick=0,this.ShellsToCheck=[],this.FireballsToCheck=[],this.SpritesToAdd=[],this.SpritesToRemove=[],this.FontShadow=SpriteCuts.CreateBlackFont(),this.Font=SpriteCuts.CreateWhiteFont();let t=0,i=0,e=0;for(let s=0;s<2;s++)t=4>>s,i=320+((16*this.Level.Width-320)/t|0),e=240+((16*this.Level.Height-240)/t|0),this.BgLayer[s]=new BackgroundRenderer(new BackgroundGenerator(i/32+1,e/32+1,0===s,this.Level.Type).CreateLevel(),320,240,t);Mario.MarioCharacter.Initialize(this),this.Sprites.Add(Mario.MarioCharacter),this.StartTime=1,this.TimeLeft=200,this.GotoMapState=!1,this.GotoLoseState=!1}Exit(){delete this.Level,delete this.Layer,delete this.BgLayer,delete this.Sprites,delete this.Camera,delete this.ShellsToCheck,delete this.FireballsToCheck,delete this.FontShadow,delete this.Font}CheckShellCollide(t){this.ShellsToCheck.push(t)}CheckFireballCollide(t){this.FireballsToCheck.push(t)}Update(t){let i=0,e=0,s=0,h=0,a=null,r=!1,n=0,o=0,l=0,d=0,c=null,u=0;for(this.Delta=t,this.TimeLeft-=t,0==(0|this.TimeLeft)&&Mario.MarioCharacter.Die(),this.StartTime>0&&this.StartTime++,this.Camera.X=Mario.MarioCharacter.X-160,this.Camera.X<0&&(this.Camera.X=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),this.FireballsOnScreen=0,i=0;i<this.Sprites.Objects.length;i++)a=this.Sprites.Objects[i],a!==Mario.MarioCharacter&&(s=a.X-this.Camera.X,h=a.Y-this.Camera.Y,s<-64||s>384||h<-64||h>304?this.Sprites.RemoveAt(i):a instanceof Fireball&&this.FireballsOnScreen++);if(this.Paused)for(i=0;i<this.Sprites.Objects.length;i++)this.Sprites.Objects[i]===Mario.MarioCharacter?this.Sprites.Objects[i].Update(t):this.Sprites.Objects[i].UpdateNoMove(t);else{for(this.Layer.Update(t),this.Level.Update(),r=!1,n=0,this.Tick++,o=(this.Camera.X/16|0)-1;o<=1+((this.Camera.X+this.Layer.Width)/16|0);o++)for(l=(this.Camera.Y/16|0)-1;l<=1+((this.Camera.Y+this.Layer.Height)/16|0);l++)if(d=0,16*o+8>Mario.MarioCharacter.X+16&&(d=-1),16*o+8<Mario.MarioCharacter.X-16&&(d=1),c=this.Level.GetSpriteTemplate(o,l),null!==c&&(c.LastVisibleTick===this.Tick-1||null!==c.Sprite&&this.Sprites.Contains(c.Sprite)||c.Spawn(this,o,l,d),c.LastVisibleTick=this.Tick),0!==d&&(u=this.Level.GetBlock(o,l),(Tile.Behaviors[255&u]&Tile.Animated)>0&&3==(u%16/4|0)&&0==(u/16|0)&&(this.Tick-2*o)%100==0)){for(n=o,i=0;i<8;i++)this.AddSprite(new Sparkle(this,16*o+8,16*l+(16*Math.random()|0),Math.random()*d,0,0,1,5));this.AddSprite(new BulletBill(this,16*o+8+8*d,16*l+15,d)),r=!0}for(r&&Engine.Resources.PlaySound("cannon"),i=0;i<this.Sprites.Objects.length;i++)this.Sprites.Objects[i].Update(t);for(i=0;i<this.Sprites.Objects.length;i++)this.Sprites.Objects[i].CollideCheck();for(i=0;i<this.ShellsToCheck.length;i++)for(e=0;e<this.Sprites.Objects.length;e++)this.Sprites.Objects[e]===this.ShellsToCheck[i]||this.ShellsToCheck[i].Dead||!this.Sprites.Objects[e].ShellCollideCheck(this.ShellsToCheck[i])||Mario.MarioCharacter.Carried!==this.ShellsToCheck[i]||this.ShellsToCheck[i].Dead||(Mario.MarioCharacter.Carried=null,this.ShellsToCheck[i].Die());for(this.ShellsToCheck.length=0,i=0;i<this.FireballsToCheck.length;i++)for(e=0;e<this.Sprites.Objects.length;e++)this.Sprites.Objects[e]!==this.FireballsToCheck[i]&&!this.FireballsToCheck[i].Dead&&this.Sprites.Objects[e].FireballCollideCheck(this.FireballsToCheck[i])&&this.FireballsToCheck[i].Die();this.FireballsToCheck.length=0}this.Sprites.AddRange(this.SpritesToAdd),this.Sprites.RemoveList(this.SpritesToRemove),this.SpritesToAdd.length=0,this.SpritesToRemove.length=0,this.Camera.X=Mario.MarioCharacter.XOld+(Mario.MarioCharacter.X-Mario.MarioCharacter.XOld)*t-160,this.Camera.Y=Mario.MarioCharacter.YOld+(Mario.MarioCharacter.Y-Mario.MarioCharacter.YOld)*t-120}LevelWon(){Mario.GlobalMapState.LevelWon(),this.GotoMapState=!0}Draw(t){let i=0,e=0;for(this.Camera.X<0?this.Camera.X=0:this.Camera.Y<0&&(this.Camera.Y=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),this.Camera.Y>16*this.Level.Height-240&&(this.Camera.Y=16*this.Level.Height-240),i=0;i<2;i++)this.BgLayer[i].Draw(t,this.Camera);for(t.save(),t.translate(-this.Camera.X,-this.Camera.Y),i=0;i<this.Sprites.Objects.length;i++)0===this.Sprites.Objects[i].Layer&&this.Sprites.Objects[i].Draw(t,this.Camera);for(t.restore(),this.Layer.Draw(t,this.Camera),this.Layer.DrawExit0(t,this.Camera,0===Mario.MarioCharacter.WinTime),t.save(),t.translate(-this.Camera.X,-this.Camera.Y),i=0;i<this.Sprites.Objects.length;i++)1===this.Sprites.Objects[i].Layer&&this.Sprites.Objects[i].Draw(t,this.Camera);t.restore(),this.Layer.DrawExit1(t,this.Camera),this.DrawUI(t),this.StartTime>0&&(e=this.StartTime+this.Delta-2,e=e*e*.6,this.RenderBlackout(t,160,120,0|e)),Mario.MarioCharacter.WinTime>0&&(e=Mario.MarioCharacter.WinTime+this.Delta,e=e*e*.2,e>900&&this.LevelWon(),this.RenderBlackout(t,Mario.MarioCharacter.XDeathPos-this.Camera.X|0,Mario.MarioCharacter.YDeathPos-this.Camera.Y|0,320-e|0)),Mario.MarioCharacter.DeathTime>0&&(e=Mario.MarioCharacter.DeathTime+this.Delta,e=e*e*.1,e>900&&(Mario.MarioCharacter.Lives--,this.GotoMapState=!0,Mario.MarioCharacter.Lives<=0&&(this.GotoLoseState=!0)),this.RenderBlackout(t,Mario.MarioCharacter.XDeathPos-this.Camera.X|0,Mario.MarioCharacter.YDeathPos-this.Camera.Y|0,320-e|0))}DrawUI(t){this.DrawStringShadow(t,"MARIO "+Mario.MarioCharacter.Lives,0,0),this.DrawStringShadow(t,"00000000",0,1),this.DrawStringShadow(t,"COIN",14,0),this.DrawStringShadow(t," "+Mario.MarioCharacter.Coins,14,1),this.DrawStringShadow(t,"WORLD",24,0),this.DrawStringShadow(t," "+Mario.MarioCharacter.LevelString,24,1),this.DrawStringShadow(t,"TIME",34,0);let i=0|this.TimeLeft;i<0&&(i=0),this.DrawStringShadow(t," "+i,34,1)}DrawStringShadow(t,i,e,s){this.Font.Strings[0]={String:i,X:8*e+4,Y:8*s+4},this.FontShadow.Strings[0]={String:i,X:8*e+5,Y:8*s+5},this.FontShadow.Draw(t,this.Camera),this.Font.Draw(t,this.Camera)}RenderBlackout(t,i,e,s){if(s>320)return;let h=[],a=[],r=0;for(r=0;r<16;r++)h[r]=i+Math.cos(r*Math.PI/15)*s|0,a[r]=e+Math.sin(r*Math.PI/15)*s|0;for(h[16]=0,a[16]=e,h[17]=0,a[17]=240,h[18]=320,a[18]=240,h[19]=320,a[19]=e,t.fillStyle="#000",t.beginPath(),t.moveTo(h[19],a[19]),r=18;r>=0;r--)t.lineTo(h[r],a[r]);for(t.closePath(),t.fill(),r=0;r<16;r++)h[r]=i-Math.cos(r*Math.PI/15)*s|0,a[r]=e-Math.sin(r*Math.PI/15)*s|0;for(a[15]+=5,h[16]=320,a[16]=e,h[17]=320,a[17]=0,h[18]=0,a[18]=0,h[19]=0,a[19]=e,t.fillStyle="#000",t.beginPath(),t.moveTo(h[0],a[0]),r=0;r<=h.length-1;r++)t.lineTo(h[r],a[r]);t.closePath(),t.fill()}AddSprite(t){this.Sprites.Add(t)}RemoveSprite(t){this.Sprites.Remove(t)}Bump(t,i,e){let s=this.Level.GetBlock(t,i),h=0,a=0;if((Tile.Behaviors[255&s]&Tile.Bumpable)>0&&(this.BumpInto(t,i-1),this.Level.SetBlock(t,i,4),this.Level.SetBlockData(t,i,4),(Tile.Behaviors[255&s]&Tile.Special)>0?(Engine.Resources.PlaySound("sprout"),Mario.MarioCharacter.Large?this.AddSprite(new FireFlower(this,16*t+8,16*i+8)):this.AddSprite(new Mushroom(this,16*t+8,16*i+8))):(Mario.MarioCharacter.GetCoin(t,i),Engine.Resources.PlaySound("coin"),this.AddSprite(new CoinAnim(this,t,i)))),(Tile.Behaviors[255&s]&Tile.Breakable)>0&&(this.BumpInto(t,i-1),e))for(Engine.Resources.PlaySound("breakblock"),this.Level.SetBlock(t,i,0),h=0;h<2;h++)for(a=0;a<2;a++)this.AddSprite(new Particle(this,16*t+8*h+4,16*i+8*a+4,4*(2*h-1),4*(2*a-1)-8))}BumpInto(t,i){let e=this.Level.GetBlock(t,i),s=0;for((Tile.Behaviors[255&e]&Tile.PickUpable)>0&&(Mario.MarioCharacter.GetCoin(t,i),Engine.Resources.PlaySound("coin"),this.Level.SetBlock(t,i,0),this.AddSprite(new CoinAnim(t,i+1))),s=0;s<this.Sprites.Objects.length;s++)this.Sprites.Objects[s].BumpCheck(t,i)}CheckForChange(t){this.GotoLoseState?t.ChangeState(new LoseState):this.GotoMapState&&t.ChangeState(Mario.GlobalMapState)}GetTimeLeft(){return this.TimeLeft}}class PredefinedLevelState extends LevelState{constructor(t,i){super(t,i),Mario.MarioCharacter.ResetMetrics(),Mario.MarioCharacter.gameplayMetrics.SetLevelState(this),this.NextLevel=!1,this.agent=new PlayerAgent}GetLevel(){return new PredefinedLevelGenerator(levels[levelsOrder[currentLevel]]).CreateLevel()}Enter(){super.Enter(),this.NextLevel=!1}CheckForChange(t){(this.GotoLoseState||this.NextLevel)&&(localStorage.setItem(`level_${levelsOrder[currentLevel]}_game`,JSON.stringify({metrics:Mario.MarioCharacter.gameplayMetrics.PrintMetrics(),actions:this.agent.GetActions()})),survey.nextPage(),survey.showNavigationButtons=!0,t.ChangeState(new LoadingState))}LevelWon(){Mario.GlobalMapState.LevelWon(),this.NextLevel=!0}DrawUI(t){this.DrawStringShadow(t,"MARIO "+Mario.MarioCharacter.Lives,0,0),this.DrawStringShadow(t,"COIN",14,0),this.DrawStringShadow(t," "+Mario.MarioCharacter.Coins,14,1),this.DrawStringShadow(t,"TIME",34,0);let i=0|this.TimeLeft;i<0&&(i=0),this.DrawStringShadow(t," "+i,34,1)}Update(t){this.agent.Update(t),super.Update(t)}}class GameplayMetrics{constructor(){this.jumps=[],this.landings=[],this.coins=[],this.noCoins=-1,this.powerups=[],this.noPowerups=-1,this.enemies=[],this.noEnemies=-1,this.timeLeft=-1,this.levelState=null}SetLevelState(t){void 0!==t.GetName&&"LevelState"===t.GetName()?this.levelState=t:console.error("SetLevelState should receive an instance of LevelState")}RegisterJump(){this.jumps.push(this.GetNearestGap())}RegisterLanding(){this.landings.push(this.GetNearestGap())}RegisterNoCoins(t){this.noCoins=t}RegisterNoPowerups(t){this.noPowerups=t}RegisterNoEnemies(t){this.noEnemies=t}CollectedCoin(t,i){const e=this.levelState.Level;if(!(e instanceof PredefinedLevel))return;const s=e.GetCoinID(t,i);null!==s?this.coins.push(s):console.error("ERROR: Coin doesn't exist!")}CollectedPowerup(t,i){const e=this.levelState.Level;if(!(e instanceof PredefinedLevel))return;const s=e.GetPowerupID(t,i);null!==s?this.powerups.push(s):console.error("ERROR: Powerup doesn't exist!")}KilledEnemy(t){this.enemies.push(t)}GetNearestGap(){const t=(Mario.MarioCharacter.X-8)/16,i=(Mario.MarioCharacter.Facing,this.levelState.Level.JumpSections);let e=1/0;for(let s=0;s<i.length;s++)if(t<i[s].GetHoleStartX()){const h=i[s].GetHoleStartX()-t;if(h>e)break;e=h}else if(t>i[s].GetHoleEndX()){const h=t-i[s].GetHoleEndX();if(h>e)break;e=h}else console.log("Inside gap: Jumping on walls");return e}RegisterEndingTime(){if(null==this.levelState)return;const t=this.levelState.GetTimeLeft();this.timeLeft=t<0?0:t}PrintMetrics(){return{jumps:this.jumps,landings:this.landings,timeLeft:this.timeLeft,noCoins:this.noCoins,collectedCoins:this.coins,noPowerups:this.noPowerups,collectedPowerups:this.powerups}}}class PredefinedTitleState extends TitleState{CheckForChange(t){Engine.KeyboardInput.IsKeyDown(Engine.Keys.S)&&t.ChangeState(new PredefinedLevelState(1,0))}}class Agent extends NotchSprite{constructor(t){super(),this.actions=t,this.ticks=0,this.time=0,this.currentEvent=0}Update(t){this.time+=t,this.ticks++}GetActions(){}}class PlayerAgent extends Agent{constructor(){super([]),document.addEventListener("keydown",this.StoreEvent.bind(this)),document.addEventListener("keyup",this.StoreEvent.bind(this))}StoreEvent(t){t.keyCode!==Engine.Keys.A&&t.keyCode!==Engine.Keys.S&&t.keyCode!==Engine.Keys.Left&&t.keyCode!==Engine.Keys.Right||this.actions.push({t:this.ticks,k:t.keyCode,e:t.type})}GetActions(){return this.actions}}class AIAgent extends Agent{constructor(t){super(t)}Update(t){for(super.Update(t);;){const t=this.actions[this.currentEvent];if(!(this.currentEvent<this.actions.length&&t.t<=this.ticks))break;document.dispatchEvent(new KeyboardEvent(t.e,{keyCode:t.k})),this.currentEvent++}}}